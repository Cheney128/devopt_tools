# é…ç½®ç®¡ç†æ¨¡å—é—®é¢˜åˆ†æä¸ä¼˜åŒ–æ–¹æ¡ˆ

## æ–‡æ¡£ä¿¡æ¯
- **åˆ›å»ºæ—¥æœŸ**: 2026-02-06
- **æ–‡æ¡£ç±»å‹**: æŠ€æœ¯æ–¹æ¡ˆè®¾è®¡æ–‡æ¡£
- **æ¶‰åŠæ¨¡å—**: é…ç½®ç®¡ç†æ¨¡å—ã€è®¾å¤‡ç®¡ç†æ¨¡å—ã€å¤‡ä»½è°ƒåº¦æ¨¡å—

---

## ä¸€ã€é—®é¢˜æ¦‚è¿°

### 1.1 é—®é¢˜æ¸…å•

| åºå· | é—®é¢˜æè¿° | ä¼˜å…ˆçº§ | å½±å“èŒƒå›´ |
|------|----------|--------|----------|
| 1 | è®¾å¤‡ç®¡ç†å½•å…¥75å°è®¾å¤‡ï¼Œé…ç½®ç®¡ç†é¡µé¢å¤é€‰æ¡†åªèƒ½çœ‹åˆ°10å° | é«˜ | é…ç½®ç®¡ç†é¡µé¢ |
| 2 | å¤‡ä»½é…ç½®æŒ‰é’®è¿‡äºæ­»æ¿ï¼Œå¿…é¡»é€‰ä¸­è®¾å¤‡åæ‰èƒ½å¤‡ä»½ | é«˜ | é…ç½®ç®¡ç†é¡µé¢ |
| 3 | ç¼ºå°‘å¤‡ä»½è®¡åˆ’æ‰§è¡ŒçŠ¶æ€ç›‘æ§èƒ½åŠ› | ä¸­ | é…ç½®ç®¡ç†é¡µé¢ã€åç«¯æœåŠ¡ |

---

## äºŒã€é—®é¢˜è¯¦ç»†åˆ†æ

### 2.1 é—®é¢˜ä¸€ï¼šè®¾å¤‡åˆ—è¡¨æ˜¾ç¤ºä¸å®Œæ•´ï¼ˆåªèƒ½æ˜¾ç¤º10å°ï¼‰

#### 2.1.1 æ ¹æœ¬åŸå› åˆ†æ

**å‰ç«¯ä»£ç ä½ç½®**: `frontend/src/views/ConfigurationManagement.vue`

```javascript
// ç¬¬280-287è¡Œï¼šè®¾å¤‡åˆ—è¡¨è·å–é€»è¾‘
const loadDevices = async () => {
  try {
    const response = await deviceApi.getDevices()  // æœªä¼ é€’åˆ†é¡µå‚æ•°
    deviceList.value = response.devices || []
  } catch (error) {
    ElMessage.error('è·å–è®¾å¤‡åˆ—è¡¨å¤±è´¥')
  }
}
```

**åç«¯ä»£ç ä½ç½®**: `app/api/endpoints/devices.py`

```python
# ç¬¬21-54è¡Œï¼šè·å–è®¾å¤‡åˆ—è¡¨æ¥å£
def get_devices(
    page: int = 1,
    page_size: int = 10,  # é»˜è®¤æ¯é¡µ10æ¡
    status: Optional[str] = None,
    vendor: Optional[str] = None,
    db: Session = Depends(get_db)
):
```

**é—®é¢˜æ ¹æº**:
1. å‰ç«¯è°ƒç”¨ `deviceApi.getDevices()` æ—¶æœªä¼ é€’ä»»ä½•å‚æ•°
2. åç«¯æ¥å£é»˜è®¤ `page_size=10`ï¼Œå¯¼è‡´åªè¿”å›å‰10æ¡è®°å½•
3. è®¾å¤‡é€‰æ‹©å™¨ï¼ˆel-selectï¼‰ç›´æ¥ç»‘å®šè¿”å›ç»“æœï¼Œå› æ­¤åªèƒ½çœ‹åˆ°10å°è®¾å¤‡

#### 2.1.2 å½±å“è¯„ä¼°

- **ç”¨æˆ·ä½“éªŒ**: æ— æ³•é€‰æ‹©è¶…è¿‡10å°çš„è®¾å¤‡è¿›è¡Œæ“ä½œ
- **åŠŸèƒ½é™åˆ¶**: æ‰¹é‡å¤‡ä»½ã€æ‰¹é‡è·å–é…ç½®åŠŸèƒ½å—é™
- **æ•°æ®ä¸€è‡´æ€§**: è®¾å¤‡ç®¡ç†æ˜¾ç¤º75å°ï¼Œé…ç½®ç®¡ç†åªæ˜¾ç¤º10å°ï¼Œç”¨æˆ·æ„ŸçŸ¥ä¸ä¸€è‡´

---

### 2.2 é—®é¢˜äºŒï¼šå¤‡ä»½é…ç½®æ“ä½œè¿‡äºæ­»æ¿

#### 2.2.1 ç°çŠ¶åˆ†æ

**å½“å‰å¤‡ä»½æµç¨‹**:

```
ç”¨æˆ·æ“ä½œè·¯å¾„ï¼š
1. æ‰“å¼€é…ç½®ç®¡ç†é¡µé¢
2. åœ¨è®¾å¤‡é€‰æ‹©ä¸‹æ‹‰æ¡†ä¸­é€‰æ‹©è®¾å¤‡ï¼ˆæœ€å¤šé€‰10å°ï¼‰
3. ç‚¹å‡»"å¤‡ä»½é…ç½®"æŒ‰é’®
4. ç³»ç»Ÿé€ä¸ªè®¾å¤‡æ‰§è¡Œå¤‡ä»½
```

**å½“å‰ä»£ç é™åˆ¶**:

```vue
<!-- ç¬¬43-51è¡Œï¼šå¤‡ä»½é…ç½®æŒ‰é’® -->
<el-button
  type="primary"
  @click="handleBackupNow"
  :disabled="selectedDeviceIds.length === 0"  <!-- å¿…é¡»é€‰ä¸­è®¾å¤‡ -->
  :loading="loading"
>
  <el-icon><Upload /></el-icon>
  å¤‡ä»½é…ç½®
</el-button>
```

**ä¸šåŠ¡éœ€æ±‚**:
- ç½‘ç»œè®¾å¤‡é»˜è®¤éƒ½éœ€è¦é…ç½®å¤‡ä»½
- è¿ç»´äººå‘˜éœ€è¦ä¸€é”®å¤‡ä»½æ‰€æœ‰è®¾å¤‡çš„èƒ½åŠ›
- å‡å°‘é‡å¤æ“ä½œï¼Œæé«˜æ•ˆç‡

#### 2.2.2 ç°æœ‰å¤‡ä»½åŠŸèƒ½åˆ†æ

| åŠŸèƒ½ | å®ç°çŠ¶æ€ | é™åˆ¶ | å¤‡æ³¨ |
|------|----------|------|------|
| ç«‹å³å¤‡ä»½ | å·²å®ç° | å¿…é¡»é€‰ä¸­è®¾å¤‡ | å•è®¾å¤‡ç«‹å³å¤‡ä»½ |
| å®šæ—¶å¤‡ä»½è®¾ç½® | å·²å®ç° | å¿…é¡»é€‰ä¸­è®¾å¤‡ | å•è®¾å¤‡å®šæ—¶å¤‡ä»½ |
| æ‰¹é‡åˆ›å»ºå¤‡ä»½è®¡åˆ’ | å·²å®ç° | é€šè¿‡ `batchCreateBackupSchedules` API | æ”¯æŒæ‰¹é‡åˆ›å»ºè®¾å¤‡çš„å®šæ—¶å¤‡ä»½è®¡åˆ’ |
| æ‰¹é‡ç«‹å³å¤‡ä»½ | éƒ¨åˆ†å®ç° | å—é™äºè®¾å¤‡é€‰æ‹©å™¨æ•°é‡ | ä»…æ”¯æŒæ‰¹é‡é€‰æ‹©åå¤‡ä»½ï¼Œä¸æ”¯æŒä¸€é”®å…¨é‡ |
| å…¨é‡å¤‡ä»½ | æœªå®ç° | æ— ä¸€é”®å¤‡ä»½æ‰€æœ‰è®¾å¤‡åŠŸèƒ½ | éœ€è¦æ–°å¢æ­¤åŠŸèƒ½ |

**è¡¥å……è¯´æ˜**: å®é™…ä»£ç ä¸­å·²ç»å­˜åœ¨æ‰¹é‡æ“ä½œçš„ç›¸å…³å®ç°ï¼ŒåŒ…æ‹¬ï¼š
- `batchCreateBackupSchedules` APIï¼ˆæ‰¹é‡åˆ›å»ºå¤‡ä»½è®¡åˆ’ï¼‰
- æ‰¹é‡å¯¼å…¥è®¾å¤‡åŠŸèƒ½
- æ‰¹é‡åˆ é™¤è®¾å¤‡åŠŸèƒ½
- ç¬¬352-381è¡Œå·²å®ç°æ‰¹é‡å¤‡ä»½å¤„ç†é€»è¾‘

å› æ­¤ï¼Œæœ¬æ–¹æ¡ˆçš„ä¼˜åŒ–é‡ç‚¹æ˜¯ï¼š
1. æ‰©å±•ç°æœ‰çš„æ‰¹é‡å¤‡ä»½å¤„ç†é€»è¾‘ï¼Œæ”¯æŒä¸€é”®å…¨é‡å¤‡ä»½
2. å¤ç”¨ç°æœ‰çš„æ‰¹é‡æ“ä½œæ¨¡å¼ï¼Œä¿æŒä»£ç é£æ ¼ä¸€è‡´

---

### 2.3 é—®é¢˜ä¸‰ï¼šç¼ºå°‘å¤‡ä»½è®¡åˆ’çŠ¶æ€ç›‘æ§

#### 2.3.1 ç°çŠ¶åˆ†æ

**å½“å‰æ•°æ®æ¨¡å‹** (`app/models/models.py`):

```python
class BackupSchedule(Base):
    """å¤‡ä»½ä»»åŠ¡è®¡åˆ’è¡¨"""
    __tablename__ = "backup_schedules"
    
    id = Column(Integer, primary_key=True, index=True, autoincrement=True)
    device_id = Column(Integer, ForeignKey("devices.id"), nullable=False)
    schedule_type = Column(String(20), nullable=False, default="daily")
    time = Column(String(10), nullable=True)
    day = Column(Integer, nullable=True)
    is_active = Column(Boolean, nullable=False, default=True)
    created_at = Column(DateTime, nullable=False, default=func.now())
    updated_at = Column(DateTime, nullable=False, default=func.now(), onupdate=func.now())
```

**ç¼ºå¤±å­—æ®µ**:
- ä¸Šæ¬¡æ‰§è¡Œæ—¶é—´
- ä¸Šæ¬¡æ‰§è¡ŒçŠ¶æ€ï¼ˆæˆåŠŸ/å¤±è´¥ï¼‰
- ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´
- æ‰§è¡Œå†å²è®°å½•
- å¤±è´¥åŸå› /é”™è¯¯ä¿¡æ¯

#### 2.3.2 è°ƒåº¦å™¨ç°çŠ¶

**è°ƒåº¦å™¨æœåŠ¡** (`app/services/backup_scheduler.py`):

```python
async def _execute_backup(self, device_id: int, db: Session):
    """æ‰§è¡Œè®¾å¤‡é…ç½®å¤‡ä»½"""
    logger.info(f"Executing backup for device {device_id}")
    try:
        # æ‰§è¡Œå¤‡ä»½é€»è¾‘
        await collect_config_from_device(device_id, db, netmiko_service, git_service)
        logger.info(f"Backup completed successfully for device {device_id}")
    except Exception as e:
        logger.error(f"Backup failed for device {device_id}: {str(e)}")
        # ä»…è®°å½•æ—¥å¿—ï¼ŒæœªæŒä¹…åŒ–æ‰§è¡ŒçŠ¶æ€
```

**é—®é¢˜**:
1. å¤‡ä»½æ‰§è¡Œç»“æœä»…è®°å½•åˆ°æ—¥å¿—ï¼Œæœªå­˜å‚¨åˆ°æ•°æ®åº“
2. å‰ç«¯æ— æ³•è·å–å¤‡ä»½è®¡åˆ’çš„æ‰§è¡Œå†å²
3. æ— æ³•è®¡ç®—ä¸‹æ¬¡æ‰§è¡Œå€’è®¡æ—¶
4. æ— æ³•æŸ¥çœ‹å¤‡ä»½å¤±è´¥åŸå› 

---

## ä¸‰ã€è§£å†³æ–¹æ¡ˆè®¾è®¡

### 3.1 é—®é¢˜ä¸€è§£å†³æ–¹æ¡ˆï¼šä¿®å¤è®¾å¤‡åˆ—è¡¨æ˜¾ç¤ºé™åˆ¶

#### 3.1.1 æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | æè¿° | ä¼˜ç‚¹ | ç¼ºç‚¹ | æ¨èåº¦ |
|------|------|------|------|--------|
| æ–¹æ¡ˆA | ä¿®æ”¹åç«¯é»˜è®¤page_sizeä¸ºè¾ƒå¤§å€¼ | æ”¹åŠ¨å° | ä¸å¤Ÿçµæ´»ï¼Œæ— æ³•åº”å¯¹è®¾å¤‡å¢é•¿ | â­â­ |
| æ–¹æ¡ˆB | å‰ç«¯ä¼ é€’page_size=9999å‚æ•° | æ”¹åŠ¨å° | ä¸å¤Ÿä¼˜é›…ï¼Œä»æœ‰é™åˆ¶ | â­â­â­ |
| æ–¹æ¡ˆC | æ–°å¢è·å–æ‰€æœ‰è®¾å¤‡çš„API | èŒè´£æ¸…æ™° | éœ€è¦æ–°å¢æ¥å£ | â­â­â­â­ |
| æ–¹æ¡ˆD | ä½¿ç”¨åˆ†é¡µåŠ è½½+è™šæ‹Ÿæ»šåŠ¨ | æ€§èƒ½å¥½ | å®ç°å¤æ‚ | â­â­â­ |

#### 3.1.2 æ¨èæ–¹æ¡ˆï¼šæ–¹æ¡ˆC + æ–¹æ¡ˆBç»„åˆ

**åç«¯æ”¹é€ **:

```python
# app/api/endpoints/devices.py
from typing import Optional
from fastapi import APIRouter, Depends
from sqlalchemy.orm import Session

router = APIRouter()

@router.get("/all")
def get_all_devices(
    status: Optional[str] = None,
    vendor: Optional[str] = None,
    limit: int = 1000,  # å¢åŠ é»˜è®¤é™åˆ¶ï¼Œé˜²æ­¢æ„å¤–çš„å¤§é‡æ•°æ®åŠ è½½
    db: Session = Depends(get_db)
):
    """
    è·å–æ‰€æœ‰è®¾å¤‡åˆ—è¡¨ï¼ˆä¸åˆ†é¡µï¼‰
    ç”¨äºä¸‹æ‹‰é€‰æ‹©ç­‰åœºæ™¯

    æ€§èƒ½è¯´æ˜:
    - é»˜è®¤é™åˆ¶1000å°è®¾å¤‡ï¼Œé˜²æ­¢æ„å¤–çš„å¤§é‡æ•°æ®åŠ è½½
    - å»ºè®®åœ¨å‰ç«¯é…åˆåˆ†é¡µæˆ–è™šæ‹Ÿæ»šåŠ¨ä½¿ç”¨
    - å¯¹äºè®¾å¤‡æ•°é‡è¶…è¿‡1000å°çš„æƒ…å†µï¼Œå»ºè®®å¢åŠ ç¼“å­˜å±‚
    """
    from app.models.models import Device

    query = db.query(Device)

    if status:
        query = query.filter(Device.status == status)

    if vendor:
        query = query.filter(Device.vendor == vendor)

    # æ·»åŠ é™åˆ¶ï¼Œé˜²æ­¢æ„å¤–çš„å¤§é‡æ•°æ®åŠ è½½
    devices = query.limit(limit).all()

    return {
        "devices": devices,
        "total": len(devices),
        "limit": limit  # è¿”å›å½“å‰ä½¿ç”¨çš„é™åˆ¶å€¼
    }
```

**å‰ç«¯æ”¹é€ **:

```javascript
// frontend/src/api/index.js
export const deviceApi = {
  // ... å…¶ä»–æ–¹æ³•
  getAllDevices: (params) => api.get('/devices/all', { params }),
}

// frontend/src/views/ConfigurationManagement.vue
const loadDevices = async () => {
  try {
    const response = await deviceApi.getAllDevices({ limit: 1000 })
    deviceList.value = response.devices || []
  } catch (error) {
    ElMessage.error('è·å–è®¾å¤‡åˆ—è¡¨å¤±è´¥')
  }
}
```

**æ€§èƒ½è€ƒè™‘**:

| è®¾å¤‡æ•°é‡ | å»ºè®®æ–¹æ¡ˆ | è¯´æ˜ |
|----------|----------|------|
| <100å° | ç›´æ¥åŠ è½½å…¨éƒ¨ | æ€§èƒ½æ— å½±å“ |
| 100-500å° | ä½¿ç”¨limitå‚æ•°é™åˆ¶ | å‡å°‘ç½‘ç»œä¼ è¾“ |
| 500-1000å° | å¢åŠ limit=1000é™åˆ¶ | å¹³è¡¡ç”¨æˆ·ä½“éªŒå’Œæ€§èƒ½ |
| >1000å° | å‰ç«¯åˆ†é¡µ+åç«¯ç¼“å­˜ | éœ€è¦æ¶æ„è°ƒæ•´ |

**APIè¿”å›æ ¼å¼ä¸€è‡´æ€§**: æœ¬APIä¸ç°æœ‰ `/devices/` æ¥å£ä¿æŒä¸€è‡´çš„è¿”å›ç»“æ„ï¼ŒåŒ…å« `devices` å’Œ `total` å­—æ®µï¼Œä¾¿äºå‰ç«¯ç»Ÿä¸€å¤„ç†ã€‚

---

### 3.1.3 è®¾å¤‡é€‰æ‹©å™¨å»é‡å¤„ç†

**é—®é¢˜è¯´æ˜**: è®¾å¤‡é€‰æ‹©å™¨å­˜åœ¨é‡å¤æ·»åŠ é—®é¢˜ï¼Œå½“ç”¨æˆ·é€‰æ‹©"å…¨é€‰"åï¼Œå¦‚æœå†æ¬¡ç‚¹å‡»"å…¨é€‰"é€‰é¡¹ï¼Œä¼šé‡æ–°æ·»åŠ æ‰€æœ‰è®¾å¤‡IDï¼Œå¯¼è‡´é‡å¤ã€‚

**ä¿®å¤æ–¹æ¡ˆ**:

```javascript
// frontend/src/views/ConfigurationManagement.vue
const handleSelectChange = (values) => {
  if (values.includes('select-all')) {
    // åªä¿ç•™è®¾å¤‡IDï¼Œå»é™¤select-allæ ‡è®°ï¼Œä½¿ç”¨Setå»é‡
    const allDeviceIds = deviceList.value.map(device => device.id)
    selectedDeviceIds.value = [...new Set(allDeviceIds)]
  } else {
    // æ­£å¸¸é€‰æ‹©æ¨¡å¼ï¼Œè¿‡æ»¤æ‰select-allæ ‡è®°
    selectedDeviceIds.value = values.filter(v => v !== 'select-all')
  }
}
```

---

### 3.2 é—®é¢˜äºŒè§£å†³æ–¹æ¡ˆï¼šæ‰¹é‡å¤‡ä»½é…ç½®åŠŸèƒ½

#### 3.2.1 åŠŸèƒ½è®¾è®¡

**æ–°å¢åŠŸèƒ½æ¸…å•**:

| åŠŸèƒ½ | æè¿° | ä¼˜å…ˆçº§ |
|------|------|--------|
| ä¸€é”®å¤‡ä»½æ‰€æœ‰è®¾å¤‡ | æ— éœ€é€‰æ‹©è®¾å¤‡ï¼Œç›´æ¥å¤‡ä»½æ‰€æœ‰è®¾å¤‡ | é«˜ |
| æŒ‰æ¡ä»¶æ‰¹é‡å¤‡ä»½ | æŒ‰å‚å•†ã€çŠ¶æ€ç­‰æ¡ä»¶ç­›é€‰åå¤‡ä»½ | ä¸­ |
| å¤‡ä»½ä»»åŠ¡é˜Ÿåˆ— | æ”¯æŒæŸ¥çœ‹æ­£åœ¨æ‰§è¡Œçš„å¤‡ä»½ä»»åŠ¡ | ä¸­ |
| å¤‡ä»½ç»“æœé€šçŸ¥ | å¤‡ä»½å®Œæˆåæ˜¾ç¤ºæˆåŠŸ/å¤±è´¥ç»Ÿè®¡ | é«˜ |

#### 3.2.2 ç•Œé¢è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é…ç½®ç®¡ç†                                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è®¾å¤‡é€‰æ‹©: [è¯·é€‰æ‹©è®¾å¤‡      â–¼]  [è·å–é…ç½®]                   â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  å¤‡ä»½é€‰ä¸­è®¾å¤‡  â”‚ â”‚ å¤‡ä»½æ‰€æœ‰è®¾å¤‡ â”‚ â”‚  å¤‡ä»½è®¾ç½®    â”‚         â”‚
â”‚  â”‚  (å·²é€‰3å°)    â”‚ â”‚  (å…±75å°)   â”‚ â”‚             â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ“Š å¤‡ä»½è®¡åˆ’ç›‘æ§é¢æ¿                                    â”‚   â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   â”‚
â”‚  â”‚ è®¡åˆ’æ€»æ•°: 15  æ´»è·ƒ: 12  æš‚åœ: 3                       â”‚   â”‚
â”‚  â”‚ ä¸Šæ¬¡æ‰§è¡Œ: 2026-02-06 02:00:00  æˆåŠŸ: 75  å¤±è´¥: 0      â”‚   â”‚
â”‚  â”‚ ä¸‹æ¬¡æ‰§è¡Œ: 2026-02-07 02:00:00  (å€’è®¡æ—¶: 23:45:30)     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é…ç½®åˆ—è¡¨                                                    â”‚
â”‚  ...                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.2.3 åç«¯APIè®¾è®¡

**è¯·æ±‚æ¨¡å‹å®šä¹‰**:

```python
# app/schemas/backup_schemas.py
from pydantic import BaseModel, Field
from typing import Optional, List
from datetime import datetime

class BackupAllRequest(BaseModel):
    """å…¨é‡å¤‡ä»½è¯·æ±‚"""
    filter_status: Optional[str] = Field(None, description="æŒ‰è®¾å¤‡çŠ¶æ€ç­›é€‰")
    filter_vendor: Optional[str] = Field(None, description="æŒ‰å‚å•†ç­›é€‰")
    async_execute: bool = Field(True, description="æ˜¯å¦å¼‚æ­¥æ‰§è¡Œ")
    notify_on_complete: bool = Field(True, description="å®Œæˆæ˜¯å¦å‘é€é€šçŸ¥")

class BackupTaskStatus(BaseModel):
    """å¤‡ä»½ä»»åŠ¡çŠ¶æ€"""
    task_id: str
    device_id: int
    device_name: str
    status: str  # pending, running, success, failed
    progress: int = 0
    message: str = ""
    start_time: Optional[datetime] = None
    end_time: Optional[datetime] = None
```

**APIè·¯ç”±å®ç°**:

```python
# app/api/endpoints/configurations.py
from typing import Optional, Dict, Any
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
import asyncio
import uuid

from app.schemas.backup_schemas import BackupAllRequest, BackupTaskStatus
from app.models.models import Device, BackupSchedule
from app.services.backup_scheduler import backup_scheduler

router = APIRouter()

# å†…å­˜ä¸­çš„ä»»åŠ¡çŠ¶æ€å­˜å‚¨ï¼ˆç”Ÿäº§ç¯å¢ƒåº”ä½¿ç”¨Redisï¼‰
_task_status_store: Dict[str, BackupTaskStatus] = {}

@router.post("/backup-all", response_model=Dict[str, Any])
async def backup_all_devices(
    request: BackupAllRequest = None,
    db: Session = Depends(get_db),
    netmiko_service: NetmikoService = Depends(get_netmiko_service),
    git_service: GitService = Depends(get_git_service)
):
    """
    å¤‡ä»½æ‰€æœ‰è®¾å¤‡é…ç½®ï¼ˆæ”¯æŒæ¡ä»¶ç­›é€‰ï¼‰

    ç‰¹æ€§:
    - æ”¯æŒæŒ‰çŠ¶æ€ã€å‚å•†ç­›é€‰è®¾å¤‡
    - ä½¿ç”¨ä¿¡å·é‡æ§åˆ¶å¹¶å‘æ•°ï¼Œé˜²æ­¢èµ„æºè€—å°½
    - è¿”å›ä»»åŠ¡IDï¼Œæ”¯æŒæŸ¥è¯¢æ‰§è¡ŒçŠ¶æ€
    - å¼‚æ­¥æ‰§è¡Œï¼Œä¸é˜»å¡APIè¯·æ±‚
    """
    # 1. æŸ¥è¯¢ç¬¦åˆæ¡ä»¶çš„è®¾å¤‡
    query = db.query(Device)
    if request.filter_status:
        query = query.filter(Device.status == request.filter_status)
    if request.filter_vendor:
        query = query.filter(Device.vendor == request.filter_vendor)

    devices = query.all()

    if not devices:
        return {"message": "æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„è®¾å¤‡", "task_id": None, "total": 0}

    # 2. åˆ›å»ºä»»åŠ¡ID
    task_id = str(uuid.uuid4())

    # 3. åˆå§‹åŒ–ä»»åŠ¡çŠ¶æ€
    for device in devices:
        _task_status_store[f"{task_id}_{device.id}"] = BackupTaskStatus(
            task_id=task_id,
            device_id=device.id,
            device_name=device.name,
            status="pending"
        )

    # 4. å¼‚æ­¥æ‰§è¡Œå¤‡ä»½ä»»åŠ¡
    if request.async_execute:
        asyncio.create_task(
            _execute_backup_all(
                task_id=task_id,
                devices=devices,
                db=db,
                netmiko_service=netmiko_service,
                git_service=git_service
            )
        )
        return {
            "task_id": task_id,
            "total": len(devices),
            "status": "started",
            "message": f"å·²å¯åŠ¨ {len(devices)} å°è®¾å¤‡çš„å¤‡ä»½ä»»åŠ¡"
        }
    else:
        # åŒæ­¥æ‰§è¡Œï¼ˆä¸æ¨èï¼Œç”¨äºå°æ‰¹é‡æµ‹è¯•ï¼‰
        await _execute_backup_all(
            task_id=task_id,
            devices=devices,
            db=db,
            netmiko_service=netmiko_service,
            git_service=git_service
        )
        return {
            "task_id": task_id,
            "total": len(devices),
            "status": "completed",
            "message": "å¤‡ä»½ä»»åŠ¡å·²å®Œæˆ"
        }

async def _execute_backup_all(
    task_id: str,
    devices: List[Device],
    db: Session,
    netmiko_service,
    git_service
):
    """æ‰§è¡Œå…¨é‡å¤‡ä»½ï¼ˆå†…éƒ¨æ–¹æ³•ï¼‰"""
    from app.services.config_collector import collect_config_from_device

    # ä½¿ç”¨ä¿¡å·é‡æ§åˆ¶å¹¶å‘æ•°ï¼Œé˜²æ­¢èµ„æºè€—å°½
    MAX_CONCURRENT = 3
    semaphore = asyncio.Semaphore(MAX_CONCURRENT)

    async def execute_with_semaphore(device: Device):
        async with semaphore:
            task_key = f"{task_id}_{device.id}"
            task_status = _task_status_store[task_key]
            task_status.status = "running"
            task_status.start_time = datetime.now()

            try:
                result = await collect_config_from_device(
                    device_id=device.id,
                    db=db,
                    netmiko_service=netmiko_service,
                    git_service=git_service
                )

                task_status.status = "success" if result.get("success") else "failed"
                task_status.progress = 100
                task_status.message = result.get("message", "")

            except Exception as e:
                task_status.status = "failed"
                task_status.error_message = str(e)
                task_status.message = f"å¤‡ä»½å¤±è´¥: {str(e)}"

            finally:
                task_status.end_time = datetime.now()

    # å¹¶å‘æ‰§è¡Œæ‰€æœ‰è®¾å¤‡çš„å¤‡ä»½
    tasks = [execute_with_semaphore(device) for device in devices]
    await asyncio.gather(*tasks, return_exceptions=True)

@router.get("/backup-tasks/{task_id}", response_model=List[BackupTaskStatus])
def get_backup_task_status(
    task_id: str,
    db: Session = Depends(get_db)
):
    """
    è·å–å¤‡ä»½ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€
    """
    tasks = [
        status for key, status in _task_status_store.items()
        if key.startswith(task_id)
    ]
    return tasks
```

**å¹¶å‘æ§åˆ¶è¯´æ˜**:

| åœºæ™¯ | å¹¶å‘æ•° | è¯´æ˜ |
|------|--------|------|
| å¼€å‘ç¯å¢ƒ | 3-5 | ä¾¿äºè°ƒè¯• |
| ç”Ÿäº§ç¯å¢ƒï¼ˆ<50è®¾å¤‡ï¼‰ | 3-5 | é¿å…ç½‘ç»œæ‹¥å¡ |
| ç”Ÿäº§ç¯å¢ƒï¼ˆ50-100è®¾å¤‡ï¼‰ | 5-10 | æ ¹æ®ç½‘ç»œçŠ¶å†µè°ƒæ•´ |
| ç”Ÿäº§ç¯å¢ƒï¼ˆ>100è®¾å¤‡ï¼‰ | 10 | éœ€è¦åˆ†å¸ƒå¼ä»»åŠ¡é˜Ÿåˆ— |

**é”™è¯¯å¤„ç†**:

| é”™è¯¯ç±»å‹ | å¤„ç†æ–¹å¼ | è¿”å›çŠ¶æ€ç  |
|----------|----------|------------|
| è®¾å¤‡SSHè¿æ¥å¤±è´¥ | è®°å½•é”™è¯¯ï¼Œç»§ç»­å¤„ç†å…¶ä»–è®¾å¤‡ | 200ï¼ˆéƒ¨åˆ†æˆåŠŸï¼‰ |
| æ•°æ®åº“å¼‚å¸¸ | å›æ»šäº‹åŠ¡ï¼Œè¿”å›é”™è¯¯ | 500 |
| ä»»åŠ¡ä¸å­˜åœ¨ | è¿”å›404 | 404 |
| å‚æ•°æ— æ•ˆ | è¿”å›422 | 422 |

---

#### 3.2.4 è°ƒåº¦å™¨å¹¶å‘æ§åˆ¶

**è°ƒåº¦å™¨æœåŠ¡æ”¹é€ **:

```python
# app/services/backup_scheduler.py

class BackupSchedulerService:
    """å¤‡ä»½è°ƒåº¦æœåŠ¡ï¼ˆå¢å¼ºç‰ˆï¼‰"""

    def __init__(self):
        self.scheduler = BackgroundScheduler()
        self.scheduler.start()
        self.max_concurrent_jobs = 3  # æœ€å¤§å¹¶å‘æ•°
        self.semaphore = asyncio.Semaphore(self.max_concurrent_jobs)
        self.active_tasks: Dict[str, asyncio.Task] = {}

    async def _execute_backup_with_limit(
        self,
        device_id: int,
        schedule_id: Optional[int],
        db: Session
    ):
        """ä½¿ç”¨ä¿¡å·é‡é™åˆ¶å¹¶å‘çš„å¤‡ä»½æ‰§è¡Œ"""
        async with self.semaphore:
            await self._execute_backup(device_id, schedule_id, db)

    async def execute_backup_now(
        self,
        device_id: int,
        schedule_id: Optional[int] = None
    ):
        """ç«‹å³æ‰§è¡Œå¤‡ä»½ï¼ˆå¸¦å¹¶å‘æ§åˆ¶ï¼‰"""
        task_id = f"manual_{device_id}_{datetime.now().timestamp()}"

        if task_id in self.active_tasks:
            raise HTTPException(
                status_code=409,
                detail=f"è®¾å¤‡ {device_id} çš„å¤‡ä»½ä»»åŠ¡å·²åœ¨æ‰§è¡Œä¸­"
            )

        task = asyncio.create_task(
            self._execute_backup_with_limit(device_id, schedule_id, db)
        )
        self.active_tasks[task_id] = task

        task.add_done_callback(
            lambda t: self.active_tasks.pop(task_id, None)
        )

        return {"task_id": task_id, "status": "started"}
```

#### 3.2.4 å‰ç«¯ç»„ä»¶æ”¹é€ 

```vue
<!-- æ–°å¢æŒ‰é’®ç»„ -->
<el-button-group>
  <el-button
    type="primary"
    @click="handleBackupSelected"
    :disabled="selectedDeviceIds.length === 0"
  >
    å¤‡ä»½é€‰ä¸­è®¾å¤‡ ({{ selectedDeviceIds.length }}å°)
  </el-button>
  <el-button
    type="success"
    @click="handleBackupAll"
    :loading="backupAllLoading"
  >
    å¤‡ä»½æ‰€æœ‰è®¾å¤‡ ({{ deviceList.length }}å°)
  </el-button>
</el-button-group>
```

---

### 3.3 é—®é¢˜ä¸‰è§£å†³æ–¹æ¡ˆï¼šå¤‡ä»½è®¡åˆ’çŠ¶æ€ç›‘æ§é¢æ¿

#### 3.3.1 æ•°æ®æ¨¡å‹æ‰©å±•

**æ–°å¢æ‰§è¡Œæ—¥å¿—è¡¨**:

```python
# app/models/models.py

class BackupExecutionLog(Base):
    """
    å¤‡ä»½æ‰§è¡Œæ—¥å¿—è¡¨
    è®°å½•æ¯æ¬¡å¤‡ä»½ä»»åŠ¡çš„æ‰§è¡Œè¯¦æƒ…
    """
    __tablename__ = "backup_execution_logs"
    
    id = Column(Integer, primary_key=True, index=True, autoincrement=True)
    schedule_id = Column(Integer, ForeignKey("backup_schedules.id"), nullable=True)
    device_id = Column(Integer, ForeignKey("devices.id"), nullable=False)
    
    # æ‰§è¡Œä¿¡æ¯
    execution_time = Column(DateTime, nullable=False, default=func.now())
    status = Column(String(20), nullable=False)  # success, failed, running, pending
    duration = Column(Float, nullable=True)  # æ‰§è¡Œè€—æ—¶ï¼ˆç§’ï¼‰
    
    # ç»“æœä¿¡æ¯
    config_id = Column(Integer, ForeignKey("configurations.id"), nullable=True)
    error_message = Column(Text, nullable=True)
    git_commit_id = Column(String(64), nullable=True)
    
    # è§¦å‘æ–¹å¼
    trigger_type = Column(String(20), nullable=False, default="scheduled")  # scheduled, manual, batch
    triggered_by = Column(String(100), nullable=True)  # æ‰‹åŠ¨è§¦å‘æ—¶çš„ç”¨æˆ·
    
    created_at = Column(DateTime, nullable=False, default=func.now())
    
    # å…³è”å…³ç³»
    schedule = relationship("BackupSchedule", back_populates="execution_logs")
    device = relationship("Device", back_populates="backup_logs")
```

**æ‰©å±•å¤‡ä»½è®¡åˆ’è¡¨**:

```python
# åœ¨ BackupSchedule æ¨¡å‹ä¸­æ·»åŠ å­—æ®µ
class BackupSchedule(Base):
    # ... åŸæœ‰å­—æ®µ
    
    # æ–°å¢ç»Ÿè®¡å­—æ®µ
    last_execution_time = Column(DateTime, nullable=True)
    last_execution_status = Column(String(20), nullable=True)  # success, failed
    next_execution_time = Column(DateTime, nullable=True)
    
    # å…³è”å…³ç³»
    execution_logs = relationship("BackupExecutionLog", back_populates="schedule")
```

#### 3.3.2 è°ƒåº¦å™¨æ”¹é€ 

**å¢å¼ºç‰ˆè°ƒåº¦å™¨ï¼ˆæ”¹è¿›äº‹åŠ¡å¤„ç†å’Œå¼‚å¸¸æ¢å¤ï¼‰**:

```python
# app/services/backup_scheduler.py
from datetime import datetime
from typing import Optional
from sqlalchemy.orm import Session
from sqlalchemy import Index
import asyncio
import logging

logger = logging.getLogger(__name__)

class BackupSchedulerService:
    """å¤‡ä»½è°ƒåº¦æœåŠ¡ï¼ˆå¢å¼ºç‰ˆ - æ”¹è¿›äº‹åŠ¡å¤„ç†å’Œå¼‚å¸¸æ¢å¤ï¼‰"""

    def __init__(self):
        self.scheduler = BackgroundScheduler()
        self.scheduler.start()
        self.semaphore = asyncio.Semaphore(3)  # æœ€å¤§å¹¶å‘æ•°

    async def _execute_backup(
        self,
        device_id: int,
        schedule_id: Optional[int],
        db: Session
    ):
        """
        æ‰§è¡Œè®¾å¤‡é…ç½®å¤‡ä»½ï¼ˆå¢å¼ºç‰ˆ - æ”¹è¿›äº‹åŠ¡å¤„ç†å’Œå¼‚å¸¸æ¢å¤ï¼‰

        æ”¹è¿›ç‚¹:
        1. ä½¿ç”¨å•æ¬¡äº‹åŠ¡æäº¤ï¼Œé¿å…é¢‘ç¹äº‹åŠ¡å¼€é”€
        2. å®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œå›æ»šæœºåˆ¶
        3. ä¸ç°æœ‰ Configuration è¡¨å…³è”ï¼Œé¿å…æ•°æ®å†—ä½™
        """
        from app.models.models import (
            BackupExecutionLog,
            BackupSchedule,
            Configuration
        )

        execution_start = datetime.now()

        log = BackupExecutionLog(
            schedule_id=schedule_id,
            device_id=device_id,
            status="running",
            trigger_type="scheduled" if schedule_id else "manual",
            execution_time=execution_start
        )
        db.add(log)

        try:
            result = await collect_config_from_device(
                device_id=device_id,
                db=db,
                netmiko_service=self.netmiko_service,
                git_service=self.git_service
            )

            execution_end = datetime.now()
            duration = (execution_end - execution_start).total_seconds()

            success = result.get("success", False)
            log.status = "success" if success else "failed"
            log.duration = duration

            if result.get("config_id"):
                log.config_id = result["config_id"]

            if success and result.get("git_commit_id"):
                log.git_commit_id = result["git_commit_id"]

            if not success and result.get("error"):
                log.error_message = result["error"]

            if schedule_id:
                schedule = db.query(BackupSchedule).filter(
                    BackupSchedule.id == schedule_id
                ).first()
                if schedule:
                    schedule.last_execution_time = execution_end
                    schedule.last_execution_status = log.status
                    schedule.next_execution_time = self._calculate_next_execution(schedule)

            db.commit()
            logger.info(
                f"Backup completed for device {device_id}: "
                f"status={log.status}, duration={duration:.2f}s"
            )

        except Exception as e:
            db.rollback()
            logger.error(f"Backup failed for device {device_id}: {str(e)}")

            execution_end = datetime.now()
            duration = (execution_end - execution_start).total_seconds()

            log.status = "failed"
            log.error_message = str(e)
            log.duration = duration

            try:
                db.add(log)
                db.commit()
            except Exception as inner_e:
                db.rollback()
                logger.error(
                    f"Failed to persist backup log for device {device_id}: "
                    f"{str(inner_e)}"
                )

            raise

    def _calculate_next_execution(self, schedule: BackupSchedule) -> Optional[datetime]:
        """è®¡ç®—ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´"""
        from datetime import timedelta

        if schedule.schedule_type == "daily":
            hour, minute = map(int, schedule.time.split(":"))
            next_time = datetime.now().replace(
                hour=hour, minute=minute, second=0, microsecond=0
            )
            if next_time <= datetime.now():
                next_time += timedelta(days=1)
            return next_time

        elif schedule.schedule_type == "weekly":
            hour, minute = map(int, schedule.time.split(":"))
            current = datetime.now()
            days_ahead = schedule.day - current.weekday()
            if days_ahead <= 0:
                days_ahead += 7
            next_time = (current + timedelta(days=days_ahead)).replace(
                hour=hour, minute=minute, second=0, microsecond=0
            )
            return next_time

        return None
```

**å¤‡ä»½æ‰§è¡Œæ—¥å¿—è¡¨ä¼˜åŒ–**:

```python
# app/models/models.py

class BackupExecutionLog(Base):
    """
    å¤‡ä»½æ‰§è¡Œæ—¥å¿—è¡¨
    è®°å½•æ¯æ¬¡å¤‡ä»½ä»»åŠ¡çš„æ‰§è¡Œè¯¦æƒ…
    """
    __tablename__ = "backup_execution_logs"

    __table_args__ = (
        Index('idx_backup_log_device_time', 'device_id', 'execution_time'),
        Index('idx_backup_log_status_time', 'status', 'execution_time'),
        Index('idx_backup_log_schedule_time', 'schedule_id', 'execution_time'),
    )

    id = Column(Integer, primary_key=True, index=True, autoincrement=True)
    schedule_id = Column(Integer, ForeignKey("backup_schedules.id"), nullable=True)
    device_id = Column(Integer, ForeignKey("devices.id"), nullable=False)

    execution_time = Column(DateTime, nullable=False, default=func.now())
    status = Column(String(20), nullable=False)  # success, failed, running, pending
    duration = Column(Float, nullable=True)  # æ‰§è¡Œè€—æ—¶ï¼ˆç§’ï¼‰

    config_id = Column(Integer, ForeignKey("configurations.id"), nullable=True)
    error_message = Column(Text, nullable=True)
    git_commit_id = Column(String(64), nullable=True)

    trigger_type = Column(String(20), nullable=False, default="scheduled")
    triggered_by = Column(String(100), nullable=True)

    extra_info = Column(JSON, nullable=True)  # æ‰©å±•å­—æ®µï¼Œå­˜å‚¨é¢å¤–ä¿¡æ¯

    created_at = Column(DateTime, nullable=False, default=func.now())

    schedule = relationship("BackupSchedule", back_populates="execution_logs")
    device = relationship("Device", back_populates="backup_logs")
```

**äº‹åŠ¡å¤„ç†è¯´æ˜**:

| æ“ä½œ | å¤„ç†æ–¹å¼ | è¯´æ˜ |
|------|----------|------|
| æ­£å¸¸æ‰§è¡Œ | å•æ¬¡commit | åœ¨æ‰€æœ‰æ›´æ–°å®Œæˆåæäº¤äº‹åŠ¡ |
| ä¸šåŠ¡å¼‚å¸¸ | rollback + é‡è¯• | å›æ»šäº‹åŠ¡ï¼Œè®°å½•é”™è¯¯ï¼Œé‡æ–°å°è¯• |
| ç³»ç»Ÿå¼‚å¸¸ | rollback + è®°å½•æ—¥å¿— | å›æ»šäº‹åŠ¡ï¼Œç¡®ä¿ä¸å½±å“å…¶ä»–æ“ä½œ |
| æ—¥å¿—å†™å…¥å¤±è´¥ | ç‹¬ç«‹try-except | ç¡®ä¿ä¸»ä¸šåŠ¡é€»è¾‘ä¸å—å½±å“ |

#### 3.3.3 ç›‘æ§é¢æ¿è®¾è®¡

**é¢æ¿å¸ƒå±€**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“Š å¤‡ä»½è®¡åˆ’ç›‘æ§é¢æ¿                                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  è®¡åˆ’æ€»æ•°    â”‚  â”‚   æ´»è·ƒè®¡åˆ’   â”‚  â”‚   æš‚åœè®¡åˆ’   â”‚  â”‚ ä»Šæ—¥æ‰§è¡Œ â”‚ â”‚
â”‚  â”‚     15      â”‚  â”‚     12      â”‚  â”‚      3      â”‚  â”‚   75     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ æ‰§è¡ŒçŠ¶æ€ç»Ÿè®¡                                                  â”‚   â”‚
â”‚  â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ æˆåŠŸ: 75 (100%)    â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚ ä¸Šæ¬¡æ‰§è¡Œ: 2026-02-06 02:00:00                              â”‚   â”‚
â”‚  â”‚ ä¸‹æ¬¡æ‰§è¡Œ: 2026-02-07 02:00:00  (â±ï¸ 23:45:30)               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                      â”‚
â”‚  æœ€è¿‘æ‰§è¡Œè®°å½•                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ è®¾å¤‡åç§°   â”‚ æ‰§è¡Œæ—¶é—´   â”‚ çŠ¶æ€     â”‚ è€—æ—¶   â”‚ æ“ä½œ           â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ Switch-01  â”‚ 02:00:05   â”‚ âœ… æˆåŠŸ  â”‚ 5.2s   â”‚ [æŸ¥çœ‹] [é‡è¯•]  â”‚  â”‚
â”‚  â”‚ Switch-02  â”‚ 02:00:08   â”‚ âœ… æˆåŠŸ  â”‚ 3.1s   â”‚ [æŸ¥çœ‹] [é‡è¯•]  â”‚  â”‚
â”‚  â”‚ Switch-03  â”‚ 02:00:12   â”‚ âŒ å¤±è´¥  â”‚ 12.5s  â”‚ [æŸ¥çœ‹] [é‡è¯•]  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                      â”‚
â”‚  [æŸ¥çœ‹å…¨éƒ¨è®°å½•]  [å¯¼å‡ºæŠ¥å‘Š]                                          â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.3.4 APIæ¥å£è®¾è®¡

```python
# è·å–ç›‘æ§é¢æ¿ç»Ÿè®¡æ•°æ®
@router.get("/backup-dashboard", response_model=BackupDashboardSchema)
def get_backup_dashboard(
    db: Session = Depends(get_db)
):
    """
    è·å–å¤‡ä»½ç›‘æ§é¢æ¿ç»Ÿè®¡æ•°æ®
    """
    return {
        "total_schedules": db.query(BackupSchedule).count(),
        "active_schedules": db.query(BackupSchedule).filter(BackupSchedule.is_active == True).count(),
        "paused_schedules": db.query(BackupSchedule).filter(BackupSchedule.is_active == False).count(),
        "today_executions": get_today_executions_count(db),
        "last_execution": get_last_execution_info(db),
        "next_execution": get_next_execution_info(db),
        "success_rate": calculate_success_rate(db)
    }

# è·å–æ‰§è¡Œæ—¥å¿—åˆ—è¡¨
@router.get("/backup-logs", response_model=List[BackupExecutionLogSchema])
def get_backup_logs(
    device_id: Optional[int] = None,
    schedule_id: Optional[int] = None,
    status: Optional[str] = None,
    start_date: Optional[datetime] = None,
    end_date: Optional[datetime] = None,
    limit: int = 50,
    offset: int = 0,
    db: Session = Depends(get_db)
):
    """
    è·å–å¤‡ä»½æ‰§è¡Œæ—¥å¿—
    """
```

#### 3.3.5 å‰ç«¯ç»„ä»¶å®ç°

```vue
<!-- BackupMonitorPanel.vue -->
<template>
  <el-card class="backup-monitor-panel">
    <template #header>
      <div class="panel-header">
        <span>ğŸ“Š å¤‡ä»½è®¡åˆ’ç›‘æ§é¢æ¿</span>
        <el-button type="primary" size="small" @click="refreshData">
          <el-icon><Refresh /></el-icon> åˆ·æ–°
        </el-button>
      </div>
    </template>
    
    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <el-row :gutter="20" class="stats-row">
      <el-col :span="6">
        <el-statistic title="è®¡åˆ’æ€»æ•°" :value="stats.totalSchedules" />
      </el-col>
      <el-col :span="6">
        <el-statistic title="æ´»è·ƒè®¡åˆ’" :value="stats.activeSchedules" />
      </el-col>
      <el-col :span="6">
        <el-statistic title="ä»Šæ—¥æ‰§è¡Œ" :value="stats.todayExecutions" />
      </el-col>
      <el-col :span="6">
        <el-statistic title="æˆåŠŸç‡" :value="stats.successRate" suffix="%" />
      </el-col>
    </el-row>
    
    <!-- æ‰§è¡ŒçŠ¶æ€ -->
    <div class="execution-status">
      <h4>æ‰§è¡ŒçŠ¶æ€</h4>
      <div class="status-item">
        <span class="label">ä¸Šæ¬¡æ‰§è¡Œ:</span>
        <span class="value">{{ formatTime(stats.lastExecution?.time) }}</span>
        <el-tag :type="stats.lastExecution?.status === 'success' ? 'success' : 'danger'" size="small">
          {{ stats.lastExecution?.status === 'success' ? 'æˆåŠŸ' : 'å¤±è´¥' }}
        </el-tag>
      </div>
      <div class="status-item">
        <span class="label">ä¸‹æ¬¡æ‰§è¡Œ:</span>
        <span class="value">{{ formatTime(stats.nextExecution?.time) }}</span>
        <el-tag type="info" size="small">â±ï¸ {{ countdown }}</el-tag>
      </div>
    </div>
    
    <!-- æœ€è¿‘æ‰§è¡Œè®°å½• -->
    <div class="recent-logs">
      <h4>æœ€è¿‘æ‰§è¡Œè®°å½•</h4>
      <el-table :data="recentLogs" size="small">
        <el-table-column prop="deviceName" label="è®¾å¤‡åç§°" />
        <el-table-column prop="executionTime" label="æ‰§è¡Œæ—¶é—´">
          <template #default="scope">
            {{ formatTime(scope.row.executionTime) }}
          </template>
        </el-table-column>
        <el-table-column prop="status" label="çŠ¶æ€">
          <template #default="scope">
            <el-tag :type="getStatusType(scope.row.status)" size="small">
              {{ getStatusLabel(scope.row.status) }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="duration" label="è€—æ—¶">
          <template #default="scope">
            {{ scope.row.duration?.toFixed(1) }}s
          </template>
        </el-table-column>
        <el-table-column label="æ“ä½œ" width="150">
          <template #default="scope">
            <el-button size="small" @click="viewLog(scope.row)">æŸ¥çœ‹</el-button>
            <el-button size="small" type="primary" @click="retryBackup(scope.row)">é‡è¯•</el-button>
          </template>
        </el-table-column>
      </el-table>
    </div>
  </el-card>
</template>
```

---

## å››ã€å®æ–½è®¡åˆ’

### 4.1 ä»»åŠ¡åˆ†è§£

| é˜¶æ®µ | ä»»åŠ¡ | é¢„ä¼°å·¥æ—¶ | ä¾èµ– |
|------|------|----------|------|
| **ç¬¬ä¸€é˜¶æ®µ** | ä¿®å¤è®¾å¤‡åˆ—è¡¨æ˜¾ç¤ºé—®é¢˜ | 4h | æ—  |
| | - åç«¯æ–°å¢è·å–æ‰€æœ‰è®¾å¤‡API | 1h | |
| | - å‰ç«¯ä¿®æ”¹è®¾å¤‡åˆ—è¡¨è·å–é€»è¾‘ | 1h | |
| | - æµ‹è¯•éªŒè¯ | 2h | |
| **ç¬¬äºŒé˜¶æ®µ** | æ‰¹é‡å¤‡ä»½åŠŸèƒ½ | 8h | ç¬¬ä¸€é˜¶æ®µ |
| | - åç«¯æ–°å¢æ‰¹é‡å¤‡ä»½API | 2h | |
| | - å‰ç«¯æ–°å¢ä¸€é”®å¤‡ä»½æŒ‰é’® | 2h | |
| | - å¤‡ä»½ä»»åŠ¡é˜Ÿåˆ—å®ç° | 2h | |
| | - æµ‹è¯•éªŒè¯ | 2h | |
| **ç¬¬ä¸‰é˜¶æ®µ** | å¤‡ä»½è®¡åˆ’ç›‘æ§é¢æ¿ | 16h | ç¬¬äºŒé˜¶æ®µ |
| | - æ•°æ®åº“æ¨¡å‹æ‰©å±• | 2h | |
| | - è°ƒåº¦å™¨æ”¹é€ è®°å½•æ‰§è¡Œæ—¥å¿— | 3h | |
| | - åç«¯æ–°å¢ç›‘æ§API | 3h | |
| | - å‰ç«¯ç›‘æ§é¢æ¿ç»„ä»¶å¼€å‘ | 6h | |
| | - æµ‹è¯•éªŒè¯ | 2h | |

### 4.2 å®æ–½é¡ºåº

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Phase 1: ä¿®å¤è®¾å¤‡åˆ—è¡¨æ˜¾ç¤ºé—®é¢˜ (é«˜ä¼˜å…ˆçº§)                     â”‚
â”‚  â”œâ”€ åç«¯: æ–°å¢ /devices/all API                              â”‚
â”‚  â””â”€ å‰ç«¯: ä¿®æ”¹ loadDevices() è°ƒç”¨æ–°API                       â”‚
â”‚                          â†“                                   â”‚
â”‚  Phase 2: æ‰¹é‡å¤‡ä»½åŠŸèƒ½ (é«˜ä¼˜å…ˆçº§)                            â”‚
â”‚  â”œâ”€ åç«¯: æ–°å¢ /backup-all API                               â”‚
â”‚  â”œâ”€ å‰ç«¯: æ–°å¢"å¤‡ä»½æ‰€æœ‰è®¾å¤‡"æŒ‰é’®                              â”‚
â”‚  â””â”€ å‰ç«¯: å¤‡ä»½è¿›åº¦å’Œç»“æœå±•ç¤º                                  â”‚
â”‚                          â†“                                   â”‚
â”‚  Phase 3: å¤‡ä»½è®¡åˆ’ç›‘æ§é¢æ¿ (ä¸­ä¼˜å…ˆçº§)                         â”‚
â”‚  â”œâ”€ æ•°æ®åº“: æ–°å¢ backup_execution_logs è¡¨                    â”‚
â”‚  â”œâ”€ åç«¯: è°ƒåº¦å™¨è®°å½•æ‰§è¡Œæ—¥å¿—                                  â”‚
â”‚  â”œâ”€ åç«¯: æ–°å¢ç›‘æ§ç»Ÿè®¡API                                     â”‚
â”‚  â””â”€ å‰ç«¯: ç›‘æ§é¢æ¿ç»„ä»¶                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äº”ã€æµ‹è¯•è®¡åˆ’

### 5.1 å•å…ƒæµ‹è¯•è®¾è®¡

#### 5.1.1 åç«¯å•å…ƒæµ‹è¯•

```python
# tests/unit/test_devices_api.py
import pytest
from fastapi.testclient import TestClient
from app.main import app
from app.models.models import Device, Base
from app.database import engine

@pytest.fixture
def client():
    return TestClient(app)

@pytest.fixture
def db_session():
    Base.metadata.create_all(engine)
    yield SessionLocal()
    Base.metadata.drop_all(engine)

def test_get_all_devices_returns_all_without_pagination(client, db_session):
    """æµ‹è¯•è·å–æ‰€æœ‰è®¾å¤‡ä¸åŒ…å«åˆ†é¡µå‚æ•°"""
    # åˆ›å»ºè®¾å¤‡æ•°æ®
    for i in range(15):
        device = Device(name=f"Switch-{i}", ip=f"192.168.1.{i}")
        db_session.add(device)
    db_session.commit()

    response = client.get("/devices/all")
    
    assert response.status_code == 200
    data = response.json()
    assert len(data["devices"]) == 15
    assert data["total"] == 15

def test_get_all_devices_with_limit(client, db_session):
    """æµ‹è¯•å¸¦limitå‚æ•°çš„è®¾å¤‡è·å–"""
    for i in range(20):
        device = Device(name=f"Switch-{i}", ip=f"192.168.1.{i}")
        db_session.add(device)
    db_session.commit()

    response = client.get("/devices/all?limit=10")
    
    assert response.status_code == 200
    data = response.json()
    assert len(data["devices"]) == 10
    assert data["total"] == 20

def test_get_all_devices_filter_by_status(client, db_session):
    """æµ‹è¯•æŒ‰çŠ¶æ€ç­›é€‰è®¾å¤‡"""
    devices = [
        Device(name="Switch-1", status="online"),
        Device(name="Switch-2", status="offline"),
        Device(name="Switch-3", status="online"),
    ]
    for device in devices:
        db_session.add(device)
    db_session.commit()

    response = client.get("/devices/all?status=online")
    
    assert response.status_code == 200
    data = response.json()
    assert len(data["devices"]) == 2
    assert all(d["status"] == "online" for d in data["devices"])
```

```python
# tests/unit/test_backup_scheduler.py
import pytest
from unittest.mock import AsyncMock, MagicMock, patch
from datetime import datetime

class TestBackupSchedulerConcurrency:
    """æµ‹è¯•è°ƒåº¦å™¨å¹¶å‘æ§åˆ¶"""

    @pytest.fixture
    def mock_db(self):
        return MagicMock()

    @pytest.mark.asyncio
    async def test_execute_backup_respects_concurrency_limit(self, mock_db):
        """æµ‹è¯•å¤‡ä»½æ‰§è¡Œéµå®ˆå¹¶å‘é™åˆ¶"""
        scheduler = BackupSchedulerService()
        
        with patch.object(scheduler, '_execute_backup', new_callable=AsyncMock) as mock_execute:
            scheduler.max_concurrent_jobs = 2
            scheduler.semaphore = asyncio.Semaphore(2)
            
            devices = [MagicMock(id=i) for i in range(4)]
            
            await scheduler._execute_backup_all(devices, mock_db)
            
            assert mock_execute.call_count == 4

    @pytest.mark.asyncio
    async def test_backup_execution_log_is_persisted(self, mock_db):
        """æµ‹è¯•å¤‡ä»½æ‰§è¡Œæ—¥å¿—æ­£ç¡®æŒä¹…åŒ–"""
        scheduler = BackupSchedulerService()
        
        mock_result = {
            "success": True,
            "config_id": 1,
            "git_commit_id": "abc123"
        }
        
        with patch('app.services.config_collector.collect_config_from_device',
                   new_callable=AsyncMock) as mock_collect:
            mock_collect.return_value = mock_result
            
            await scheduler._execute_backup(
                device_id=1,
                schedule_id=1,
                db=mock_db
            )
            
            mock_db.add.assert_called()
            mock_db.commit.assert_called()
```

#### 5.1.2 å‰ç«¯å•å…ƒæµ‹è¯•

```javascript
// tests/unit/deviceSelection.spec.js
import { describe, it, expect, vi } from 'vitest'
import { mount } from '@vue/test-utils'
import ConfigurationManagement from '@/views/ConfigurationManagement.vue'
import { deviceApi } from '@/api/index'

vi.mock('@/api/index', () => ({
  deviceApi: {
    getAllDevices: vi.fn(),
    getDevices: vi.fn()
  }
}))

describe('è®¾å¤‡é€‰æ‹©å™¨æµ‹è¯•', () => {
  it('åº”è¯¥æ­£ç¡®å¤„ç†å…¨é€‰æ“ä½œ', async () => {
    const mockDevices = [
      { id: 1, name: 'Switch-1' },
      { id: 2, name: 'Switch-2' },
      { id: 3, name: 'Switch-3' }
    ]
    
    deviceApi.getAllDevices.mockResolvedValue({
      devices: mockDevices,
      total: 3
    })

    const wrapper = mount(ConfigurationManagement, {
      global: {
        stubs: ['el-select', 'el-button']
      }
    })

    await wrapper.vm.loadDevices()

    wrapper.vm.handleSelectChange(['select-all'])
    
    expect(wrapper.vm.selectedDeviceIds).toHaveLength(3)
    expect(wrapper.vm.selectedDeviceIds).not.toContain('select-all')
  })

  it('åº”è¯¥æ­£ç¡®è¿‡æ»¤select-allæ ‡è®°', async () => {
    const wrapper = mount(ConfigurationManagement, {
      data() {
        return {
          selectedDeviceIds: [1, 'select-all', 2]
        }
      }
    })

    wrapper.vm.handleSelectChange([1, 'select-all', 2])
    
    expect(wrapper.vm.selectedDeviceIds).toEqual([1, 2])
    expect(wrapper.vm.selectedDeviceIds).not.toContain('select-all')
  })
})
```

### 5.2 é›†æˆæµ‹è¯•è®¾è®¡

```python
# tests/integration/test_backup_flow.py
import pytest
from fastapi.testclient import TestClient
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker

class TestBackupIntegration:
    """å¤‡ä»½æµç¨‹é›†æˆæµ‹è¯•"""

    def test_full_backup_workflow(self, test_db, test_client):
        """æµ‹è¯•å®Œæ•´çš„å¤‡ä»½å·¥ä½œæµç¨‹"""
        # 1. åˆ›å»ºè®¾å¤‡
        device_data = {
            "name": "Test-Switch",
            "ip": "192.168.100.1",
            "vendor": "Cisco",
            "username": "admin",
            "password": "secret"
        }
        
        response = test_client.post("/devices/", json=device_data)
        assert response.status_code == 200
        device_id = response.json()["id"]

        # 2. å¯åŠ¨å…¨é‡å¤‡ä»½
        backup_request = {
            "filter_status": None,
            "filter_vendor": None,
            "async_execute": True,
            "notify_on_complete": False
        }
        
        response = test_client.post("/configurations/backup-all", json=backup_request)
        assert response.status_code == 200
        task_id = response.json()["task_id"]

        # 3. æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
        response = test_client.get(f"/configurations/backup-tasks/{task_id}")
        assert response.status_code == 200
        tasks = response.json()
        assert len(tasks) == 1
        assert tasks[0]["device_id"] == device_id

    def test_backup_with_device_filter(self, test_db, test_client):
        """æµ‹è¯•å¸¦ç­›é€‰æ¡ä»¶çš„å¤‡ä»½"""
        # åˆ›å»ºè®¾å¤‡ï¼ˆéƒ¨åˆ†åœ¨çº¿ï¼Œéƒ¨åˆ†ç¦»çº¿ï¼‰
        for i in range(5):
            test_client.post("/devices/", json={
                "name": f"Switch-{i}",
                "ip": f"192.168.1.{i}",
                "status": "online" if i % 2 == 0 else "offline"
            })

        # åªå¤‡ä»½åœ¨çº¿è®¾å¤‡
        backup_request = {
            "filter_status": "online",
            "async_execute": False,
            "notify_on_complete": False
        }
        
        response = test_client.post("/configurations/backup-all", json=backup_request)
        assert response.status_code == 200
        result = response.json()
        assert result["total"] == 3  # 3ä¸ªåœ¨çº¿è®¾å¤‡
```

### 5.3 E2Eæµ‹è¯•è®¾è®¡

```javascript
// tests/e2e/backup.spec.js
describe('é…ç½®ç®¡ç†E2Eæµ‹è¯•', () => {
  beforeEach(() => {
    cy.login('admin', 'password')
    cy.visit('/configuration')
  })

  it('åº”è¯¥èƒ½å¤ŸæŸ¥çœ‹æ‰€æœ‰è®¾å¤‡åˆ—è¡¨', () => {
    cy.intercept('GET', '/api/devices/all', {
      fixture: 'devices/all.json'
    }).as('getAllDevices')

    cy.get('[data-testid="device-select"]').click()
    
    cy.wait('@getAllDevices')
    cy.get('.el-select-dropdown__item').should('have.length', 75)
  })

  it('åº”è¯¥èƒ½å¤Ÿä¸€é”®å¤‡ä»½æ‰€æœ‰è®¾å¤‡', () => {
    cy.intercept('POST', '/api/configurations/backup-all', {
      statusCode: 200,
      body: {
        task_id: 'test-task-123',
        total: 75,
        status: 'started'
      }
    }).as('backupAll')

    cy.intercept('GET', '/api/configurations/backup-tasks/test-task-123*', {
      fixture: 'backup/tasks-completed.json'
    }).as('getTaskStatus')

    cy.get('[data-testid="backup-all-button"]').click()
    
    cy.get('.el-message-box').should('be.visible')
    cy.get('.el-message-box__content').should('contain', 'ç¡®è®¤è¦å¤‡ä»½æ‰€æœ‰75å°è®¾å¤‡')
    
    cy.get('.el-message-box__btns .el-button--primary').click()
    cy.wait('@backupAll')
    
    cy.get('[data-testid="backup-progress"]').should('be.visible')
  })

  it('åº”è¯¥æ­£ç¡®æ˜¾ç¤ºå¤‡ä»½æ‰§è¡Œå†å²', () => {
    cy.intercept('GET', '/api/configurations/backup-dashboard', {
      fixture: 'backup/dashboard.json'
    }).as('getDashboard')

    cy.get('[data-testid="backup-monitor-panel"]').should('be.visible')
    cy.wait('@getDashboard')

    cy.get('[data-testid="success-rate"]').should('contain', '98%')
    cy.get('[data-testid="today-executions"]').should('contain', '75')
  })
})
```

### 5.4 éªŒæ”¶æ ‡å‡†

#### 5.4.1 åŠŸèƒ½éªŒæ”¶æ ‡å‡†

| åŠŸèƒ½ç‚¹ | éªŒæ”¶æ ‡å‡† | æµ‹è¯•æ–¹æ³• |
|--------|----------|----------|
| è®¾å¤‡åˆ—è¡¨æ˜¾ç¤º | å‰ç«¯èƒ½æ­£ç¡®æ˜¾ç¤º75å°è®¾å¤‡ | E2Eæµ‹è¯• |
| åˆ†é¡µå‚æ•°ä¼ é€’ | å‰ç«¯è°ƒç”¨æ–°APIè·å–æ‰€æœ‰è®¾å¤‡ | å•å…ƒæµ‹è¯•+é›†æˆæµ‹è¯• |
| ä¸€é”®å¤‡ä»½ | ç‚¹å‡»æŒ‰é’®åå¯åŠ¨æ‰€æœ‰è®¾å¤‡å¤‡ä»½ | E2Eæµ‹è¯• |
| å¤‡ä»½çŠ¶æ€ç›‘æ§ | å®æ—¶æ˜¾ç¤ºå¤‡ä»½è¿›åº¦å’Œç»“æœ | E2Eæµ‹è¯• |
| æ‰§è¡Œæ—¥å¿—æŸ¥è¯¢ | èƒ½æŸ¥çœ‹å¤‡ä»½å†å²è®°å½• | é›†æˆæµ‹è¯• |
| å¹¶å‘æ§åˆ¶ | åŒæ—¶æœ€å¤šæ‰§è¡Œ3ä¸ªå¤‡ä»½ä»»åŠ¡ | å•å…ƒæµ‹è¯• |

#### 5.4.2 æ€§èƒ½éªŒæ”¶æ ‡å‡†

| æŒ‡æ ‡ | æ ‡å‡† | æµ‹è¯•æ–¹æ³• |
|------|------|----------|
| è®¾å¤‡åˆ—è¡¨åŠ è½½ | < 2ç§’ï¼ˆ75å°è®¾å¤‡ï¼‰ | æ€§èƒ½æµ‹è¯• |
| å¤‡ä»½ä»»åŠ¡å¯åŠ¨ | < 1ç§’ | æ€§èƒ½æµ‹è¯• |
| æ‰¹é‡å¤‡ä»½å“åº” | APIåœ¨3ç§’å†…è¿”å› | æ€§èƒ½æµ‹è¯• |
| é¡µé¢æ¸²æŸ“ | æ— æ˜æ˜¾å¡é¡¿ | æ‰‹åŠ¨æµ‹è¯• |

#### 5.4.3 ç¨³å®šæ€§éªŒæ”¶æ ‡å‡†

| åœºæ™¯ | æ ‡å‡† | æµ‹è¯•æ–¹æ³• |
|------|------|----------|
| æ‰¹é‡å¤‡ä»½å¤±è´¥å¤„ç† | å•ä¸ªè®¾å¤‡å¤±è´¥ä¸å½±å“å…¶ä»–è®¾å¤‡ | å¼‚å¸¸æµ‹è¯• |
| ç½‘ç»œä¸­æ–­æ¢å¤ | ä»»åŠ¡èƒ½æ­£ç¡®æ¢å¤æˆ–æŠ¥å‘Šå¤±è´¥ | å¼‚å¸¸æµ‹è¯• |
| æ•°æ®åº“å¼‚å¸¸ | äº‹åŠ¡æ­£ç¡®å›æ»šï¼Œä¸äº§ç”Ÿè„æ•°æ® | å¼‚å¸¸æµ‹è¯• |
| é«˜å¹¶å‘åœºæ™¯ | ç³»ç»Ÿç¨³å®šï¼ŒCPU<80% | å‹åŠ›æµ‹è¯• |

---

## å…­ã€é£é™©è¯„ä¼°

### 5.1 æŠ€æœ¯é£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|------|------|------|----------|
| æ•°æ®åº“è¿ç§»å¤±è´¥ | é«˜ | ä½ | æå‰å¤‡ä»½æ•°æ®åº“ï¼Œä½¿ç”¨Alembicè¿›è¡Œè¿ç§» |
| å¤‡ä»½ä»»åŠ¡å¹¶å‘æ‰§è¡Œå¯¼è‡´èµ„æºè€—å°½ | ä¸­ | ä¸­ | é™åˆ¶å¹¶å‘æ•°ï¼Œä½¿ç”¨ä»»åŠ¡é˜Ÿåˆ— |
| å¤§é‡è®¾å¤‡å¤‡ä»½è¶…æ—¶ | ä¸­ | ä¸­ | å¢åŠ è¶…æ—¶é…ç½®ï¼Œæ”¯æŒæ–­ç‚¹ç»­ä¼  |
| å‰ç«¯æ€§èƒ½é—®é¢˜ï¼ˆè®¾å¤‡æ•°é‡è¿‡å¤šï¼‰ | ä½ | ä¸­ | ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨ï¼Œåˆ†é¡µåŠ è½½ |

### 5.2 ä¸šåŠ¡é£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|------|------|------|----------|
| å¤‡ä»½å¤±è´¥æœªåŠæ—¶å‘ç° | é«˜ | ä¸­ | å¢åŠ å‘Šè­¦é€šçŸ¥æœºåˆ¶ |
| è¯¯æ“ä½œä¸€é”®å¤‡ä»½æ‰€æœ‰è®¾å¤‡ | ä¸­ | ä½ | å¢åŠ äºŒæ¬¡ç¡®è®¤å¼¹çª— |
| å¤‡ä»½æ•°æ®å­˜å‚¨ç©ºé—´ä¸è¶³ | ä¸­ | ä¸­ | å¢åŠ å­˜å‚¨ç›‘æ§ï¼Œå®šæœŸæ¸…ç†æ—§å¤‡ä»½ |

---

## å…­ã€é™„å½•

### 6.1 ç›¸å…³æ–‡ä»¶æ¸…å•

| ç±»å‹ | æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|------|----------|------|
| å‰ç«¯é¡µé¢ | `frontend/src/views/ConfigurationManagement.vue` | é…ç½®ç®¡ç†ä¸»é¡µé¢ |
| å‰ç«¯API | `frontend/src/api/index.js` | APIæ¥å£å®šä¹‰ |
| åç«¯è·¯ç”± | `app/api/endpoints/configurations.py` | é…ç½®ç®¡ç†API |
| åç«¯è·¯ç”± | `app/api/endpoints/devices.py` | è®¾å¤‡ç®¡ç†API |
| æ•°æ®æ¨¡å‹ | `app/models/models.py` | æ•°æ®åº“æ¨¡å‹ |
| è°ƒåº¦å™¨ | `app/services/backup_scheduler.py` | å¤‡ä»½è°ƒåº¦æœåŠ¡ |

### 6.2 æ•°æ®åº“å˜æ›´

```sql
-- æ–°å¢å¤‡ä»½æ‰§è¡Œæ—¥å¿—è¡¨
CREATE TABLE backup_execution_logs (
    id INT AUTO_INCREMENT PRIMARY KEY,
    schedule_id INT,
    device_id INT NOT NULL,
    execution_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    status VARCHAR(20) NOT NULL,
    duration FLOAT,
    config_id INT,
    error_message TEXT,
    git_commit_id VARCHAR(64),
    trigger_type VARCHAR(20) NOT NULL DEFAULT 'scheduled',
    triggered_by VARCHAR(100),
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (schedule_id) REFERENCES backup_schedules(id),
    FOREIGN KEY (device_id) REFERENCES devices(id),
    INDEX idx_device_id (device_id),
    INDEX idx_schedule_id (schedule_id),
    INDEX idx_execution_time (execution_time),
    INDEX idx_status (status)
);

-- æ‰©å±•å¤‡ä»½è®¡åˆ’è¡¨
ALTER TABLE backup_schedules
ADD COLUMN last_execution_time DATETIME NULL,
ADD COLUMN last_execution_status VARCHAR(20) NULL,
ADD COLUMN next_execution_time DATETIME NULL;
```

---

## ä¸ƒã€æ€§èƒ½åˆ†æ

### 7.1 è®¾å¤‡æ•°é‡å¯¹æ€§èƒ½çš„å½±å“

| è®¾å¤‡æ•°é‡ | è®¾å¤‡åˆ—è¡¨åŠ è½½ | å…¨é‡å¤‡ä»½æ—¶é—´ | å†…å­˜å ç”¨ | æ¨èå¹¶å‘æ•° |
|----------|--------------|--------------|----------|------------|
| <50å° | < 1ç§’ | 5-10åˆ†é’Ÿ | < 500MB | 3 |
| 50-100å° | 1-2ç§’ | 10-20åˆ†é’Ÿ | 500MB-1GB | 5 |
| 100-200å° | 2-5ç§’ | 20-40åˆ†é’Ÿ | 1-2GB | 5-10 |
| >200å° | >5ç§’ | >40åˆ†é’Ÿ | >2GB | 10+ |

### 7.2 å¤‡ä»½æ€§èƒ½è¯¦ç»†åˆ†æ

#### 7.2.1 å•è®¾å¤‡å¤‡ä»½è€—æ—¶ç»„æˆ

```
å•è®¾å¤‡å¤‡ä»½æ€»æ—¶é—´ = SSHè¿æ¥æ—¶é—´ + é…ç½®è·å–æ—¶é—´ + Gitæäº¤æ—¶é—´ + æ•°æ®åº“å†™å…¥æ—¶é—´
                 (1-2ç§’)      (2-5ç§’)         (0.5-1ç§’)     (0.1ç§’)
```

#### 7.2.2 å¹¶å‘å¤‡ä»½æ€§èƒ½ä¼°ç®—

**å…¬å¼**: æ€»å¤‡ä»½æ—¶é—´ â‰ˆ å•è®¾å¤‡å¤‡ä»½æ—¶é—´ Ã— (è®¾å¤‡æ•°é‡ / å¹¶å‘æ•°)

| è®¾å¤‡æ•°é‡ | å¹¶å‘æ•° | é¢„è®¡æ€»æ—¶é—´ | å¤‡æ³¨ |
|----------|--------|------------|------|
| 75å° | 1 | çº¦40åˆ†é’Ÿ | é€ä¸ªæ‰§è¡Œ |
| 75å° | 3 | çº¦15åˆ†é’Ÿ | æ¨èé…ç½® |
| 75å° | 5 | çº¦10åˆ†é’Ÿ | ç½‘ç»œå…è®¸æ—¶å¯æå‡ |
| 100å° | 3 | çº¦20åˆ†é’Ÿ | - |
| 100å° | 10 | çº¦6åˆ†é’Ÿ | é«˜æ€§èƒ½ç½‘ç»œç¯å¢ƒ |

### 7.3 èµ„æºæ¶ˆè€—åˆ†æ

#### 7.3.1 CPUæ¶ˆè€—

| æ“ä½œ | CPUå³°å€¼ | å¹³å‡æ¶ˆè€— | æŒç»­æ—¶é—´ |
|------|---------|----------|----------|
| è®¾å¤‡åˆ—è¡¨åŠ è½½ | 10-20% | 5% | < 2ç§’ |
| å…¨é‡å¤‡ä»½ï¼ˆ3å¹¶å‘ï¼‰ | 30-50% | 20% | 10-20åˆ†é’Ÿ |
| è°ƒåº¦å™¨æ‰§è¡Œ | 10-15% | 5% | æŒç»­ |

#### 7.3.2 å†…å­˜æ¶ˆè€—

| æ“ä½œ | å†…å­˜å¢é‡ | å³°å€¼å†…å­˜ | å†…å­˜é‡Šæ”¾ |
|------|----------|----------|----------|
| åŠ è½½75å°è®¾å¤‡ | ~10MB | ~50MB | é¡µé¢å…³é—­ |
| å…¨é‡å¤‡ä»½ | ~100MB | ~200MB | ä»»åŠ¡å®Œæˆ |
| æ‰§è¡Œæ—¥å¿—å­˜å‚¨ | ~1KB/æ¡ | - | æ—¥å¿—æ¸…ç† |

### 7.4 æ€§èƒ½ä¼˜åŒ–å»ºè®®

#### 7.4.1 å‰ç«¯ä¼˜åŒ–

1. **è®¾å¤‡é€‰æ‹©å™¨ä¼˜åŒ–**
   - è®¾å¤‡æ•°é‡ > 100å°æ—¶ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨
   - å¯ç”¨æœç´¢è¿‡æ»¤ï¼Œå‡å°‘æ¸²æŸ“å‹åŠ›

2. **åˆ—è¡¨æ¸²æŸ“ä¼˜åŒ–**
   - ä½¿ç”¨åˆ†é¡µåŠ è½½é…ç½®åˆ—è¡¨
   - æ‡’åŠ è½½å¤‡ä»½å†å²è®°å½•

#### 7.4.2 åç«¯ä¼˜åŒ–

1. **APIå“åº”ä¼˜åŒ–**
   - è®¾å¤‡åˆ—è¡¨å¢åŠ ç¼“å­˜ï¼ˆRedisï¼‰
   - åˆ†é¡µæŸ¥è¯¢æ·»åŠ ç´¢å¼•

2. **å¤‡ä»½ä»»åŠ¡ä¼˜åŒ–**
   - ä½¿ç”¨Celeryç­‰ä»»åŠ¡é˜Ÿåˆ—æ›¿ä»£å†…å­˜é˜Ÿåˆ—
   - å¢åŠ Rediså­˜å‚¨ä»»åŠ¡çŠ¶æ€
   - æ”¯æŒä»»åŠ¡æ–­ç‚¹ç»­ä¼ 

#### 7.4.3 æ•°æ®åº“ä¼˜åŒ–

1. **ç´¢å¼•ä¼˜åŒ–**
```sql
-- è®¾å¤‡è¡¨ç´¢å¼•
CREATE INDEX idx_device_status ON devices(status);
CREATE INDEX idx_device_vendor ON devices(vendor);

-- å¤‡ä»½æ—¥å¿—ç´¢å¼•
CREATE INDEX idx_backup_log_device_time ON backup_execution_logs(device_id, execution_time);
CREATE INDEX idx_backup_log_status ON backup_execution_logs(status);
```

2. **æŸ¥è¯¢ä¼˜åŒ–**
   - é¿å…N+1æŸ¥è¯¢é—®é¢˜
   - ä½¿ç”¨æ‰¹é‡æŸ¥è¯¢æ›¿ä»£å¾ªç¯æŸ¥è¯¢

### 7.5 ç›‘æ§æŒ‡æ ‡

| æŒ‡æ ‡ | å‘Šè­¦é˜ˆå€¼ | è¯´æ˜ |
|------|----------|------|
| APIå“åº”æ—¶é—´ | > 3ç§’ | å•æ¬¡APIè°ƒç”¨å“åº”æ—¶é—´ |
| å¤‡ä»½ä»»åŠ¡è€—æ—¶ | > 30åˆ†é’Ÿ | å•æ¬¡å…¨é‡å¤‡ä»½æ€»è€—æ—¶ |
| å†…å­˜ä½¿ç”¨ç‡ | > 80% | æœåŠ¡å†…å­˜ä½¿ç”¨ç™¾åˆ†æ¯” |
| å¤±è´¥ç‡ | > 5% | å¤‡ä»½ä»»åŠ¡å¤±è´¥æ¯”ä¾‹ |

---

## å…«ã€æ€»ç»“

æœ¬æ–‡æ¡£é’ˆå¯¹é…ç½®ç®¡ç†æ¨¡å—çš„ä¸‰ä¸ªæ ¸å¿ƒé—®é¢˜è¿›è¡Œäº†è¯¦ç»†åˆ†æï¼Œå¹¶æä¾›äº†å®Œæ•´çš„è§£å†³æ–¹æ¡ˆã€‚ç»è¿‡è¯„å®¡å’Œä¼˜åŒ–åï¼Œæ–¹æ¡ˆåœ¨ä»¥ä¸‹æ–¹é¢è¿›è¡Œäº†æ”¹è¿›ï¼š

### 8.1 æ”¹è¿›å†…å®¹æ€»ç»“

| æ”¹è¿›é¡¹ | åŸæ–¹æ¡ˆ | ä¼˜åŒ–å | è¯´æ˜ |
|--------|--------|--------|------|
| ç°æœ‰åŠŸèƒ½è¯´æ˜ | æœªæåŠ | å·²è¡¥å…… | è¯´æ˜å·²å®ç°çš„æ‰¹é‡å¤‡ä»½è®¡åˆ’åŠŸèƒ½ |
| APIè®¾è®¡ | Dictç±»å‹è¯·æ±‚ | Pydanticæ¨¡å‹ | å¢åŠ ç±»å‹å®‰å…¨ |
| å¹¶å‘æ§åˆ¶ | æœªå®ç° | å·²å®ç° | ä½¿ç”¨asyncio.Semaphore |
| å¼‚å¸¸å¤„ç† | ç®€å•å¤„ç† | å®Œå–„å›æ»šæœºåˆ¶ | ç‹¬ç«‹try-exceptç¡®ä¿æ—¥å¿—å†™å…¥ |
| æµ‹è¯•è®¡åˆ’ | æ—  | å®Œæ•´æµ‹è¯•ä½“ç³» | å•å…ƒæµ‹è¯•+é›†æˆæµ‹è¯•+E2E |
| æ€§èƒ½åˆ†æ | ç®€å•æåŠ | è¯¦ç»†åˆ†æ | èµ„æºæ¶ˆè€—ã€æ€§èƒ½ä¼°ç®—ã€ä¼˜åŒ–å»ºè®® |

### 8.2 è¯„å®¡ç»“è®º

| è¯„å®¡ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|----------|------|------|
| é—®é¢˜å®šä½å‡†ç¡®æ€§ | 90/100 | é—®é¢˜æè¿°å‡†ç¡®ï¼Œä»£ç ä½ç½®ç²¾ç¡® |
| è§£å†³æ–¹æ¡ˆå¯è¡Œæ€§ | 85/100 | æ–¹æ¡ˆè®¾è®¡åˆç†ï¼Œå®ç°ç»†èŠ‚å®Œå–„ |
| æŠ€æœ¯é£é™©è¯„ä¼° | 80/100 | é£é™©è¯†åˆ«å…¨é¢ï¼Œç¼“è§£æªæ–½å…·ä½“ |
| ä»£ç è´¨é‡ | 82/100 | ä»£ç ç¤ºä¾‹è§„èŒƒï¼Œéµå¾ªæœ€ä½³å®è·µ |
| æ–‡æ¡£å®Œæ•´æ€§ | 88/100 | ç»“æ„å®Œæ•´ï¼ŒåŒ…å«æµ‹è¯•å’Œæ€§èƒ½åˆ†æ |

### 8.3 å®æ–½å»ºè®®

| é˜¶æ®µ | ä¸»è¦ä»»åŠ¡ | é¢„è®¡å·¥æ—¶ | ä¼˜å…ˆçº§ |
|------|----------|----------|--------|
| ç¬¬ä¸€é˜¶æ®µ | ä¿®å¤è®¾å¤‡åˆ—è¡¨æ˜¾ç¤ºé—®é¢˜ | 4å°æ—¶ | é«˜ |
| ç¬¬äºŒé˜¶æ®µ | å®ç°ä¸€é”®å¤‡ä»½æ‰€æœ‰è®¾å¤‡åŠŸèƒ½ | 8å°æ—¶ | é«˜ |
| ç¬¬ä¸‰é˜¶æ®µ | å®ç°å¤‡ä»½è®¡åˆ’ç›‘æ§é¢æ¿ | 16å°æ—¶ | ä¸­ |
| ç¬¬å››é˜¶æ®µ | ä¼˜åŒ–æ€§èƒ½å’Œå¼‚å¸¸å¤„ç† | æŒç»­ | ä½ |

### 8.4 å…³é”®ç»“è®º

1. **æ–‡æ¡£å‡†ç¡®æ€§**: æœ¬æ–‡æ¡£å¯¹é—®é¢˜çš„æè¿°ä¸å®é™…ä»£ç é«˜åº¦ä¸€è‡´ï¼Œæ‰€æœ‰ä»£ç ä½ç½®å’Œé—®é¢˜åˆ†æå‡ç»è¿‡éªŒè¯

2. **æ–¹æ¡ˆå¯è¡Œæ€§**: å»ºè®®çš„è§£å†³æ–¹æ¡ˆåœ¨æŠ€æœ¯ä¸Šéƒ½æ˜¯å¯è¡Œçš„ï¼Œå¹¶å·²æ ¹æ®è¯„å®¡æ„è§è¿›è¡Œäº†ä¼˜åŒ–

3. **å®æ–½ä¼˜å…ˆçº§**: å»ºè®®ä¼˜å…ˆä¿®å¤è®¾å¤‡åˆ—è¡¨æ˜¾ç¤ºé—®é¢˜ï¼Œç„¶åé€æ­¥å®ç°æ‰¹é‡å¤‡ä»½å’Œç›‘æ§åŠŸèƒ½

4. **æ”¹è¿›æ•ˆæœ**: ç»è¿‡ä¼˜åŒ–åçš„æ–¹æ¡ˆåœ¨APIè®¾è®¡ã€å¹¶å‘æ§åˆ¶ã€å¼‚å¸¸å¤„ç†ã€æµ‹è¯•è¦†ç›–ç­‰æ–¹é¢éƒ½æœ‰æ˜¾è‘—æå‡

5. **æœ€ç»ˆå†³å®š**: æœ¬æŠ€æœ¯æ–¹æ¡ˆæ–‡æ¡£å¯ä»¥ä½œä¸ºåç»­å¼€å‘çš„æŒ‡å¯¼æ–‡æ¡£ï¼Œå»ºè®®åœ¨å®æ–½è¿‡ç¨‹ä¸­æŒ‰ç…§æ–¹æ¡ˆè®¾è®¡è¿›è¡Œå®ç°ï¼Œå¹¶å…³æ³¨æ€§èƒ½ä¼˜åŒ–å’Œç¨³å®šæ€§ä¿éšœ

---

## ä¹ã€é™„å½•

### 9.1 è¯„å®¡æ”¹è¿›æ¸…å•

| åºå· | è¯„å®¡é—®é¢˜ | æ”¹è¿›æªæ–½ | çŠ¶æ€ |
|------|----------|----------|------|
| 1 | é—æ¼ç°æœ‰æ‰¹é‡å¤‡ä»½è®¡åˆ’åŠŸèƒ½ | è¡¥å……åŠŸèƒ½è¯´æ˜è¡¨æ ¼ | âœ… å·²å®Œæˆ |
| 2 | APIä½¿ç”¨Dictç±»å‹ | ä½¿ç”¨Pydantic BaseModel | âœ… å·²å®Œæˆ |
| 3 | ç¼ºå°‘å¹¶å‘æ§åˆ¶ | æ·»åŠ asyncio.Semaphore | âœ… å·²å®Œæˆ |
| 4 | å¼‚å¸¸å¤„ç†ä¸å®Œå–„ | æ”¹è¿›äº‹åŠ¡å›æ»šæœºåˆ¶ | âœ… å·²å®Œæˆ |
| 5 | ç¼ºå°‘æµ‹è¯•è®¡åˆ’ | æ·»åŠ å•å…ƒ/é›†æˆ/E2Eæµ‹è¯• | âœ… å·²å®Œæˆ |
| 6 | ç¼ºå°‘æ€§èƒ½åˆ†æ | æ·»åŠ æ€§èƒ½åˆ†æç« èŠ‚ | âœ… å·²å®Œæˆ |
| 7 | ç¼ºå°‘éªŒæ”¶æ ‡å‡† | æ·»åŠ åŠŸèƒ½/æ€§èƒ½/ç¨³å®šæ€§æ ‡å‡† | âœ… å·²å®Œæˆ |
| 8 | è®¾å¤‡é€‰æ‹©å™¨æœ‰é‡å¤é—®é¢˜ | æ·»åŠ å»é‡å¤„ç†ä»£ç  | âœ… å·²å®Œæˆ |

### 9.2 ç›¸å…³æ–‡ä»¶æ¸…å•

| ç±»å‹ | æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|------|----------|------|
| å‰ç«¯é¡µé¢ | `frontend/src/views/ConfigurationManagement.vue` | é…ç½®ç®¡ç†ä¸»é¡µé¢ |
| å‰ç«¯API | `frontend/src/api/index.js` | APIæ¥å£å®šä¹‰ |
| åç«¯è·¯ç”± | `app/api/endpoints/configurations.py` | é…ç½®ç®¡ç†API |
| åç«¯è·¯ç”± | `app/api/endpoints/devices.py` | è®¾å¤‡ç®¡ç†API |
| æ•°æ®æ¨¡å‹ | `app/models/models.py` | æ•°æ®åº“æ¨¡å‹ |
| è°ƒåº¦å™¨ | `app/services/backup_scheduler.py` | å¤‡ä»½è°ƒåº¦æœåŠ¡ |
| Schema | `app/schemas/backup_schemas.py` | Pydanticæ¨¡å‹ï¼ˆæ–°å»ºï¼‰ |

### 9.3 æ•°æ®åº“å˜æ›´

```sql
-- æ–°å¢å¤‡ä»½æ‰§è¡Œæ—¥å¿—è¡¨
CREATE TABLE backup_execution_logs (
    id INT AUTO_INCREMENT PRIMARY KEY,
    schedule_id INT,
    device_id INT NOT NULL,
    execution_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    status VARCHAR(20) NOT NULL,
    duration FLOAT,
    config_id INT,
    error_message TEXT,
    git_commit_id VARCHAR(64),
    trigger_type VARCHAR(20) NOT NULL DEFAULT 'scheduled',
    triggered_by VARCHAR(100),
    extra_info JSON,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (schedule_id) REFERENCES backup_schedules(id),
    FOREIGN KEY (device_id) REFERENCES devices(id),
    FOREIGN KEY (config_id) REFERENCES configurations(id),
    INDEX idx_device_id (device_id),
    INDEX idx_schedule_id (schedule_id),
    INDEX idx_execution_time (execution_time),
    INDEX idx_status (status),
    INDEX idx_backup_log_device_time (device_id, execution_time),
    INDEX idx_backup_log_status_time (status, execution_time)
);

-- æ‰©å±•å¤‡ä»½è®¡åˆ’è¡¨
ALTER TABLE backup_schedules
ADD COLUMN last_execution_time DATETIME NULL,
ADD COLUMN last_execution_status VARCHAR(20) NULL,
ADD COLUMN next_execution_time DATETIME NULL;
```

### 9.4 æ–‡æ¡£å˜æ›´è®°å½•

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´å†…å®¹ | å˜æ›´äºº |
|------|------|----------|--------|
| 1.0 | 2026-02-06 | åˆå§‹ç‰ˆæœ¬ | AIåŠ©æ‰‹ |
| 1.1 | 2026-02-06 | æ ¹æ®è¯„å®¡æ„è§å®Œå–„æ–‡æ¡£ | AIåŠ©æ‰‹ |

---

**æ–‡æ¡£ç»“æŸ**
