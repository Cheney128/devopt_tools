# 登录功能模块与用户管理功能模块实施方案（gpt-5.2）

> **制定日期**: 2026-02-04  
> **文档版本**: v1.0  
> **适用项目**: 交换机批量管理与巡检系统  
> **原则**: 后端沿用现有接口风格（成功返回业务数据；失败使用HTTP状态码+detail），前端通过拦截器与路由守卫实现鉴权闭环

---

## 目录

1. [项目概述](#1-项目概述)
2. [需求分析](#2-需求分析)
3. [技术与约束](#3-技术与约束)
4. [总体设计](#4-总体设计)
5. [前端设计](#5-前端设计)
6. [后端接口设计（沿用现有风格）](#6-后端接口设计沿用现有风格)
7. [数据模型与权限模型](#7-数据模型与权限模型)
8. [实施步骤（不含代码）](#8-实施步骤不含代码)
9. [测试计划](#9-测试计划)
10. [风险与应对](#10-风险与应对)

---

## 1. 项目概述

### 1.1 背景

当前系统前端为 Vue3 管理台，路由均可直接访问，后端 API 未做用户身份校验，存在“任意访问者可操作系统功能”的风险。需补齐登录认证与用户管理能力，为后续权限控制、审计与多用户协作打基础。

### 1.2 目标

登录模块（P0）：
- 支持用户名/密码登录
- 图形验证码防暴力破解（后端强制校验）
- Token 会话管理（Bearer Access Token）
- 登出与登录态失效处理（401自动退出）

用户管理模块（P0/P1）：
- 管理员：用户列表/新增/编辑/启用禁用/重置密码
- 普通用户：个人中心（查看与修改个人信息、修改密码）
- 权限模型：先落地 RBAC 最小集（admin/user），权限粒度可迭代细化

### 1.3 范围边界（避免一次性做重）

第一阶段只保证“鉴权闭环 + 最小 RBAC + 用户管理可用”。以下能力建议作为后续迭代：
- refresh token 轮转、Token 黑名单、单点登录、设备级细粒度权限
- 审计日志（登录日志/操作日志）与安全告警

---

## 2. 需求分析

### 2.1 登录功能需求

| 需求ID | 需求描述 | 优先级 | 验收标准 |
|--------|----------|--------|----------|
| LOGIN-001 | 用户名密码登录 | P0 | 输入正确用户名密码后成功进入系统 |
| LOGIN-002 | 图形验证码验证 | P0 | 验证码可刷新；后端强制校验正确性与有效期 |
| LOGIN-003 | 表单前端验证 | P0 | 非空/长度/格式校验实时反馈 |
| LOGIN-004 | Token存储与携带 | P0 | 前端请求自动携带 Authorization Bearer |
| LOGIN-005 | 登录状态保持 | P1 | 支持“记住我”（延长登录态或刷新策略） |
| LOGIN-006 | 错误提示处理 | P1 | 登录失败提示明确；失败次数限制生效 |
| LOGIN-007 | 登出功能 | P0 | 登出后 Token 失效或前端清理，回到登录页 |

验证码与暴力破解策略（建议默认）：
- 验证码长度：4位（数字+字母）
- 有效期：5分钟
- 使用一次：校验成功后标记已使用
- 失败限制：同账号连续失败 5 次锁定 15 分钟（锁定逻辑后端强制）

### 2.2 用户管理功能需求

角色定义（最小集）：
| 角色 | 标识 | 权限范围 |
|------|------|----------|
| 管理员 | admin | 系统全部功能 + 用户管理 |
| 普通用户 | user | 系统功能（不含用户管理），仅维护自身资料 |

管理员功能：
| 需求ID | 功能 | 描述 |
|--------|------|------|
| USER-001 | 用户列表 | 分页展示所有用户，支持关键字与状态筛选 |
| USER-002 | 新增用户 | 创建新用户并分配角色 |
| USER-003 | 编辑用户 | 修改用户信息、角色、状态 |
| USER-004 | 禁用用户 | 软禁用账户（不可登录/不可调用受保护接口） |
| USER-005 | 重置密码 | 管理员重置用户密码 |

普通用户功能：
| 需求ID | 功能 | 描述 |
|--------|------|------|
| PROFILE-001 | 查看个人信息 | 展示当前登录用户信息 |
| PROFILE-002 | 编辑个人信息 | 修改昵称、邮箱、手机号等 |
| PROFILE-003 | 修改密码 | 校验旧密码后设置新密码 |

---

## 3. 技术与约束

### 3.1 前端现状（约束）

- Vue 3 + Vite + Vue Router + Pinia + Element Plus + Axios
- Axios 实例为单例，响应拦截器目前返回 `response.data`（对 blob 例外）
- Router 当前无鉴权守卫、无 `/login` 路由
- 项目以 JavaScript 为主（非 TypeScript）

### 3.2 后端现状（约束）

- FastAPI + SQLAlchemy + MySQL（pymysql）
- 多数接口成功时直接返回业务数据结构；错误通过 `HTTPException(status_code, detail=...)` 返回
- CORS 当前允许所有来源（后续如引入 cookie 需要收紧；本方案第一阶段不依赖 cookie）

### 3.3 本方案的接口风格约定（关键）

为与现有后端一致，本方案明确：
- 成功响应：直接返回业务数据（不包一层 success/message/data）
- 失败响应：使用 HTTP 状态码表达失败类型（401/403/404/422/500），错误信息写入 `detail`

前端约定：
- 业务成功分支：按接口定义直接取数据
- 失败分支：统一在 Axios 响应拦截器中处理 401/403/422，做提示与跳转

---

## 4. 总体设计

### 4.1 认证与鉴权闭环

核心链路：
1) 用户访问受保护页面 → 路由守卫发现未登录 → 跳转登录页  
2) 登录成功 → 前端保存 access token 与用户信息 → 跳转到首页/原访问页  
3) 任意 API 请求 → Axios 请求拦截器自动带上 `Authorization: Bearer <token>`  
4) 后端校验 token + 用户状态（active/locked）+ 权限 → 返回数据或抛 HTTPException  
5) 前端收到 401 → 清理登录态并跳转登录页；收到 403 → 提示无权限

### 4.2 权限模型演进策略

第一阶段：RBAC（admin/user）即可满足“用户管理仅管理员可见/可用”。  
第二阶段：引入 permissions（如 `device:write`、`inspection:run`）实现更细粒度授权。

---

## 5. 前端设计

### 5.1 页面与路由

新增路由（建议）：
- `/login`：登录页（独立布局，不显示主框架导航）
- `/users`：用户管理（管理员可见）
- `/profile`：个人中心（所有登录用户可见）

路由 meta（建议）：
- `requiresAuth: true/false`
- `roles: ['admin']`（用户管理页）

### 5.2 全局鉴权（路由守卫）

路由守卫职责：
- 未登录访问受保护路由：跳转 `/login`，记录 `redirect` 参数
- 已登录访问 `/login`：跳转首页
- 已登录但无角色权限访问管理员路由：跳转首页并提示“无权限”

### 5.3 Token 管理策略（第一阶段推荐）

- token 存储：localStorage（与现有项目轻量接入匹配）
- token 过期：由后端 `exp` 控制；前端遇到 401 自动退出

安全提示（可选但建议写入项目规范）：
- 强制 CSP / 依赖安全扫描可作为后续加固项，降低 XSS 风险

### 5.4 Axios 拦截器策略

请求拦截器：
- 若存在 token，则注入 `Authorization: Bearer <token>`

响应拦截器：
- 401：清理登录态，跳转登录页
- 403：提示无权限
- 422：表单参数错误提示（优先使用后端返回 detail）
- 其它错误：统一提示“操作失败”，并保留可追踪信息（不输出敏感字段）

### 5.5 组件与复用

建议新增/复用的 UI 单元：
- Captcha 组件：负责展示验证码图片、刷新、向父组件回传 captcha_id 与输入值
- 权限渲染：首版建议优先使用路由 meta + 菜单渲染控制；指令/组件作为增强项再补

### 5.6 菜单与顶栏改造点

- 顶栏用户信息来自 authStore（username/nickname/avatar）
- “退出登录”绑定登出逻辑（清理 token 与用户状态，并跳转 login）
- 菜单按角色动态渲染：普通用户隐藏“用户管理”

---

## 6. 后端接口设计（沿用现有风格）

### 6.1 统一约定

请求头：
- `Authorization: Bearer <access_token>`

失败响应：
- 400：请求体不合法（自定义校验失败）
- 401：未登录/Token无效或过期/用户被禁用
- 403：已登录但无权限
- 404：资源不存在
- 422：FastAPI/Pydantic 参数校验错误（前端做统一提示）

### 6.2 认证相关接口

#### 6.2.1 获取验证码

`GET /api/v1/auth/captcha`

成功响应（200）：
- `{ captcha_id: string, captcha_image: string(base64 data url), expires_in: number }`

失败响应：
- 500（detail：生成失败原因）

#### 6.2.2 登录

`POST /api/v1/auth/login`

请求体：
- `username: string`
- `password: string`
- `captcha_id: string`
- `captcha_code: string`
- `remember?: boolean`（可选，用于影响 token 过期策略）

成功响应（200）：
- `{ access_token: string, token_type: "bearer", expires_in: number, user: object }`

失败响应（示例语义）：
- 401 detail：用户名或密码错误
- 401 detail：验证码错误或已过期
- 401 detail：账号已锁定（携带 locked_until 也可选）
- 403 detail：账号已禁用

#### 6.2.3 获取当前用户信息

`GET /api/v1/auth/me`

成功响应（200）：
- 用户对象（建议包含 `id, username, nickname, roles, status, is_superuser` 等）

失败响应：
- 401 detail：未登录或 token 无效

#### 6.2.4 登出

`POST /api/v1/auth/logout`

说明：
- 第一阶段登出以“前端清理 + 后端可选记录登出事件”为主；不做 token 黑名单
- 如需立即失效，可在后续迭代引入黑名单/会话表

成功响应（200）：
- `{ ok: true }` 或空对象（与现有风格保持简洁）

### 6.3 用户管理接口（管理员）

#### 6.3.1 获取用户列表

`GET /api/v1/users`

查询参数（建议与现有 devices 风格一致）：
- `page`：默认 1
- `page_size`：默认 20
- `keyword`：用户名/昵称模糊匹配
- `status`：active/inactive
- `role`：admin/user

成功响应（200）：
- `{ total: number, items: User[], page: number, page_size: number }`

失败响应：
- 401：未登录
- 403：非管理员访问

#### 6.3.2 创建用户

`POST /api/v1/users`

请求体：
- `username, password, nickname?, email?, phone?, role: "admin"|"user", status?: "active"|"inactive"`

成功响应（201）：
- 创建后的 User 对象（不返回 password_hash）

失败响应：
- 409：用户名已存在（detail：duplicate username）
- 403：非管理员

#### 6.3.3 更新用户

`PUT /api/v1/users/{user_id}`

请求体：
- `nickname?, email?, phone?, role?, status?`

成功响应（200）：
- 更新后的 User 对象

失败响应：
- 404：用户不存在
- 403：非管理员

#### 6.3.4 重置用户密码

`POST /api/v1/users/{user_id}/reset-password`

请求体：
- `new_password`

成功响应（200）：
- `{ ok: true }`

失败响应：
- 404：用户不存在
- 403：非管理员

### 6.4 个人中心接口

#### 6.4.1 更新个人信息

`PUT /api/v1/users/me`

请求体：
- `nickname?, email?, phone?, avatar?`

成功响应（200）：
- 更新后的 User 对象

#### 6.4.2 修改密码

`PUT /api/v1/users/me/password`

请求体：
- `old_password, new_password`

成功响应（200）：
- `{ ok: true }`

失败响应：
- 401：旧密码错误
- 422：新密码不符合规则

---

## 7. 数据模型与权限模型

### 7.1 数据表建议

用户表（users）核心字段：
- 账户：username、password_hash
- 状态：status（active/inactive）、failed_login_attempts、locked_until、last_login、login_ip
- 展示：nickname、email、phone、avatar

角色表（roles）建议最小集：
- admin、user

用户角色关联（user_roles）：
- 支持一个用户多个角色（为后续扩展保留空间）

验证码记录表（captcha_records）：
- captcha_id、captcha_code、expired_at、used

### 7.2 权限校验策略（后端强制）

第一阶段策略：
- `admin`：允许访问 `/api/v1/users*`
- `user`：禁止访问 `/api/v1/users`（管理员接口）

建议的实现习惯（不涉及代码，仅约定）：
- 所有受保护接口统一依赖“获取当前用户”的鉴权依赖
- 鉴权依赖必须校验：token 有效、用户 status、是否锁定
- 授权依赖必须校验：角色匹配

---

## 8. 实施步骤（不含代码）

### 8.1 第一阶段：后端鉴权闭环（P0）

1) 明确用户表/角色表/验证码表的迁移方式（初始化 SQL 或 Alembic，二选一）  
2) 增加认证相关 API：captcha/login/me/logout  
3) 增加用户管理 API：users 列表/创建/更新/重置密码  
4) 为受保护业务接口补齐鉴权依赖（至少对写操作；是否对读操作也加由产品决定）  

交付物：
- API 文档（OpenAPI 自动生成 + 关键说明）
- 初始化管理员账号与角色数据

### 8.2 第二阶段：前端接入（P0）

1) 新增登录页与路由  
2) 增加 authStore（保存 token 与用户信息）  
3) 接入 Axios 拦截器（Bearer + 401/403 处理）  
4) 增加路由守卫（requiresAuth + roles）  
5) 顶栏用户区与“退出登录”联动 authStore  

交付物：
- 登录闭环可用：未登录不可访问系统主体页面
- 退出登录与 token 失效可用

### 8.3 第三阶段：用户管理与个人中心（P0/P1）

1) 管理员用户列表（分页/筛选）  
2) 新增/编辑/禁用用户（表单校验与错误提示）  
3) 重置密码与个人中心（修改资料/修改密码）  

---

## 9. 测试计划

后端：
- 单元测试：密码哈希验证、token 校验、锁定逻辑、角色校验
- API 测试：登录成功/失败/锁定、用户列表权限、禁用用户后访问受限接口返回 403/401

前端：
- 关键链路：未登录访问任意页面 → 跳转登录；登录后回跳；401 自动退出
- 角色可见性：普通用户隐藏用户管理入口；强行访问 `/users` 返回无权限提示

---

## 10. 风险与应对

1) 风格割裂风险：auth/users 返回包装而其他接口不包装  
- 应对：本方案统一“沿用现有接口风格”，并在前端集中处理错误提示与跳转

2) Token 存储安全风险（localStorage + XSS）  
- 应对：第一阶段先落地闭环；后续迭代引入 CSP、依赖扫描与更安全的 refresh cookie 策略

3) 权限只做前端隐藏导致越权风险  
- 应对：后端强制鉴权与授权；前端仅作为体验优化

4) 账号锁定与验证码策略导致用户体验问题  
- 应对：失败提示明确；提供验证码刷新；锁定信息对用户可见（提示剩余时间）

