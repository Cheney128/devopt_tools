# 2026-02-06 批量上传功能修复与环境配置优化

## 会话背景

用户反馈生产环境（10.23.65.95）的批量设备上传功能失效，同时需要优化环境变量配置，使生产环境使用 `.env.docker` 作为环境变量源。

## 碰到的问题

### 问题1：批量上传功能导致后端服务崩溃

**现象**：
- 用户尝试批量导入设备时，后端服务反复崩溃
- Nginx 返回 502 Bad Gateway 错误
- 日志显示 `upstream prematurely closed connection`

**根本原因**：
- 容器内安装的 `numpy 2.0.2` 与 `pandas 2.3.3` 存在兼容性问题
- 当处理 Excel 文件时，触发 `SIGSEGV`（段错误）导致 Python 进程崩溃

**错误日志**：
```
switch_manage_unified  | 2026-02-06 04:07:45,008 WARN exited: backend (terminated by SIGSEGV (core dumped); not expected)
```

### 问题2：环境变量配置不规范

**现象**：
- 生产环境使用 `.env` 文件（开发测试环境配置）
- `docker-compose.yml` 中硬编码了环境变量
- 缺乏环境配置分离机制

## 处理思路

### 问题1处理思路

1. **诊断阶段**：
   - 登录远程服务器检查容器状态
   - 查看后端服务日志定位崩溃原因
   - 分析错误类型（SIGSEGV 段错误）

2. **分析阶段**：
   - 检查 pandas/numpy 版本兼容性
   - 发现 numpy 2.0+ 与 pandas 存在已知兼容性问题
   - 确定需要降级 numpy 到 1.26.x 稳定版本

3. **修复阶段**：
   - 修改 `requirements.txt` 锁定 numpy 和 pandas 版本
   - 重新构建 Docker 镜像
   - 验证修复效果

### 问题2处理思路

1. **配置分离**：
   - `.env` - 用于开发测试环境
   - `.env.docker` - 用于生产 Docker 环境

2. **修改 docker-compose.yml**：
   - 添加 `env_file` 配置加载 `.env.docker`
   - 移除硬编码的环境变量
   - 保留必要的覆盖配置（DEBUG=False, DEPLOY_MODE=unified）

3. **更新 .env.docker**：
   - 使用容器内部数据库连接（`db:3306`）
   - 设置生产环境参数（DEBUG=False）

## 完成的操作

### 1. 修复批量上传功能

**修改文件**：`requirements.txt`

```diff
 # Excel处理依赖
-pandas>=2.2.0
+# 固定numpy和pandas版本以避免SIGSEGV段错误（numpy 2.0+与pandas兼容性问题）
+numpy==1.26.4
+pandas==2.2.0
 openpyxl==3.1.2
```

**版本变更**：
- numpy: 2.0.2 → 1.26.4
- pandas: 2.3.3 → 2.2.0

**部署操作**：
1. 提交代码变更到 Git
2. 在服务器上更新 `requirements.txt`
3. 清理 Docker 构建缓存：`docker builder prune -f`
4. 重新构建镜像：`docker compose build --no-cache`
5. 重启容器：`docker compose up -d`

### 2. 优化环境变量配置

**修改文件**：`docker-compose.yml`

```diff
 services:
   app:
     container_name: switch_manage_unified
     ports:
       - "80:80"
-    environment:
-      - DATABASE_URL=mysql+pymysql://root:[OylKbYLJf*Hx((4dEIf]@db:3306/switch_manage
-      - APP_NAME=Switch Manage System
-      - APP_VERSION=1.0.0
+    env_file:
+      - .env.docker
+    environment:
       - DEBUG=False
       - DEPLOY_MODE=unified
```

**修改文件**：`.env.docker`

```diff
 # 数据库连接信息
 # 注意：密码中的特殊字符需要URL编码，@ -> %40
-DATABASE_URL=mysql+pymysql://root:[OylKbYLJf*Hx((4dEIf@10.23.65.95/switch_manage
+# 使用容器内部连接：db 是数据库服务名
+DATABASE_URL=mysql+pymysql://root:[OylKbYLJf*Hx((4dEIf]@db:3306/switch_manage
 
 # 应用配置
 APP_NAME=Switch Manage System
 APP_VERSION=1.0.0
-DEBUG=True
+DEBUG=False
```

**部署操作**：
1. 在服务器上更新 `docker-compose.yml` 和 `.env.docker`
2. 重启容器：`docker compose down && docker compose up -d`
3. 验证环境变量加载

## 验证结果

### 批量上传功能

| 检查项 | 结果 |
|--------|------|
| numpy 版本 | 1.26.4 ✅ |
| pandas 版本 | 2.2.0 ✅ |
| 容器状态 | healthy ✅ |
| 验证码 API | 正常返回 ✅ |
| 后端服务 | 稳定运行，无崩溃 ✅ |

### 环境配置

| 配置项 | 值 | 状态 |
|--------|-----|------|
| DATABASE_URL | `mysql+pymysql://root:[OylKbYLJf*Hx((4dEIf]@db:3306/switch_manage` | ✅ |
| DEBUG | `False` | ✅ |
| APP_NAME | `Switch Manage System` | ✅ |
| 当前数据库 | `switch_manage` | ✅ |
| 数据库表数量 | 17 个表 | ✅ |

## 环境配置说明

| 环境 | 配置文件 | 用途 | 数据库连接 |
|------|----------|------|------------|
| 开发/测试 | `.env` | 本地开发使用 | 外部数据库（10.21.65.20:3307）|
| 生产/Docker | `.env.docker` | Docker 容器使用 | 内部数据库服务（db:3306）|

## 相关文件变更记录

- `requirements.txt` - 锁定 numpy/pandas 版本
- `docker-compose.yml` - 使用 env_file 加载环境变量
- `.env.docker` - 更新为生产环境配置
- `docs/diff-change.md` - 变更记录文档

## 后续建议

1. **监控**：持续观察批量上传功能稳定性
2. **版本管理**：定期检查和更新依赖版本，避免类似兼容性问题
3. **环境隔离**：确保开发、测试、生产环境配置严格分离
4. **文档维护**：及时更新部署文档，记录环境配置变更
