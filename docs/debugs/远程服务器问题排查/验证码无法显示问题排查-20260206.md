# 生产环境验证码无法显示问题排查总结

## 问题概述

- **发现时间**: 2026-02-06
- **问题现象**: 登录页面无法显示验证码，浏览器控制台报错 `获取验证码失败`
- **影响范围**: 生产环境 (10.23.65.95)
- **本地环境**: 正常，无此问题

## 问题背景

在修复批量设备上传功能后，重新登录服务器时发现登录页面的验证码无法正常显示。前端页面报错2条日志，提示获取验证码失败。

## 排查过程

### 1. 检查容器状态

登录远程服务器后，首先检查 Docker 容器状态：

```bash
docker compose ps
```

**结果**: 容器状态显示为 `healthy`，但后续日志分析发现后端服务实际上在循环崩溃。

### 2. 查看容器日志

查看后端容器日志：

```bash
docker compose logs app --tail 100
```

**发现**: 后端服务 `backend` 持续崩溃重启，最终进入 `FATAL` 状态：

```
WARN exited: backend (exit status 2; not expected)
...
INFO gave up: backend entered FATAL state, too many start retries too quickly
```

### 3. 定位根本原因

查看 supervisor 错误日志：

```bash
docker compose exec app cat /var/log/supervisor/backend-error.log
```

**关键错误信息**:

```
Usage: uvicorn [OPTIONS] APP
Try 'uvicorn --help' for help.

Error: No such option: --limit-max-requests-jitter Did you mean --limit-max-requests?
```

### 4. 问题分析

检查 `supervisord.conf` 配置文件：

```bash
docker compose exec app cat /etc/supervisor/conf.d/supervisord.conf
```

发现问题配置行：

```ini
command=uvicorn app.main:app --host 127.0.0.1 --port 8000 --workers 1 --timeout-keep-alive 300 --limit-max-requests 1000 --limit-max-requests-jitter 50
```

**问题原因**: 
- `--limit-max-requests-jitter` 参数是较新版本 uvicorn 才支持的选项
- 容器内安装的 uvicorn 版本不支持该参数，导致后端服务启动失败
- 由于 supervisor 配置了 `autorestart=true`，服务不断尝试重启，最终进入 FATAL 状态
- 后端 API 服务不可用，导致验证码接口 `/api/v1/auth/captcha` 无法访问

### 5. 为什么本地环境正常

本地开发环境使用 `uvicorn app.main:app --reload` 直接启动，没有使用 supervisord 配置文件中的参数，因此不受此问题影响。

## 修复方案

### 修改文件

**文件**: `docker/supervisord.conf`

**修改内容**:

```diff
- command=uvicorn app.main:app --host 127.0.0.1 --port 8000 --workers 1 --timeout-keep-alive 300 --limit-max-requests 1000 --limit-max-requests-jitter 50
+ command=uvicorn app.main:app --host 127.0.0.1 --port 8000 --workers 1 --timeout-keep-alive 300 --limit-max-requests 1000
```

### 部署步骤

1. **停止现有容器**:
   ```bash
   docker compose down
   ```

2. **重新构建镜像**（不使用缓存）:
   ```bash
   docker compose build --no-cache
   ```

3. **启动服务**:
   ```bash
   docker compose up -d
   ```

4. **验证修复**:
   ```bash
   # 检查容器状态
   docker compose ps
   
   # 测试验证码API
   curl -s http://localhost/api/v1/auth/captcha
   ```

## 验证结果

- [x] 容器状态: `healthy`
- [x] 后端服务: `RUNNING` 状态，不再崩溃
- [x] 验证码API: 正常返回 JSON 数据，包含 `captcha_id`、`captcha_image` 和 `expires_in`
- [x] 登录页面: 验证码图片正常显示

## 经验总结

### 问题根源
1. 配置文件中使用了不兼容的 uvicorn 参数
2. 容器镜像构建时使用了缓存，导致配置更新未生效
3. 本地开发环境与生产环境启动方式不一致，导致问题未在本地发现

### 改进建议
1. **版本兼容性检查**: 在使用新参数前，确认当前安装的版本是否支持
2. **环境一致性**: 保持本地开发环境与生产环境的配置一致性
3. **配置验证**: 在部署前验证配置文件的正确性
4. **日志监控**: 建立容器健康状态监控，及时发现服务异常

### 相关文件
- `docker/supervisord.conf` - Supervisor 配置文件
- `docker/Dockerfile.unified` - 统一部署镜像构建文件

---

**排查人员**: AI Assistant  
**完成时间**: 2026-02-06  
**状态**: 已修复
