# 生产环境批量上传设备502错误排查总结

> **排查日期**: 2026-02-05  
> **问题类型**: HTTP 502 Bad Gateway  
> **影响范围**: 设备管理-批量设备上传功能  
> **排查人员**: AI Assistant  
> **相关文档**: [批量上传设备功能修复总结文档](../20260205/前端页面-设备管理-批量设备上传失效/修复总结文档.md)

---

## 1. 问题背景

### 1.1 前置修复
在本地测试环境，批量上传设备功能已修复完成（详见修复总结文档），修复内容包括：
- 修复静默跳过问题
- 添加错误报告机制
- 优化性能（批量插入、分批处理）
- 完善数据验证

### 1.2 生产环境问题
将修复后的代码部署到生产环境后，用户反馈：
- **现象**: 上传Excel文件时，前端报错 `上传失败：Request failed with status code 502`
- **触发条件**: 点击"确定上传"按钮后
- **错误码**: HTTP 502 Bad Gateway

---

## 2. 环境信息

| 项目 | 信息 |
|------|------|
| 服务器IP | 10.23.65.95 |
| SSH端口 | 22022 |
| 项目目录 | /data/it-devops |
| 部署方式 | Docker Compose |
| 应用容器 | switch_manage_unified |
| 数据库容器 | switch_manage_db (MariaDB 11) |
| 前端端口 | 80 (Nginx) |
| 后端端口 | 8000 (Uvicorn) |

---

## 3. 排查过程

### 3.1 Phase 1: 收集证据

#### 3.1.1 检查容器状态
```bash
docker compose ps
```
**结果**: 容器状态正常，均为 `healthy`
```
NAME                    STATUS
switch_manage_db        Up 2 minutes (healthy)
switch_manage_unified   Up 2 minutes (healthy)
```

#### 3.1.2 检查Nginx错误日志
```bash
docker compose exec app cat /var/log/nginx/error.log
```
**关键发现**:
```
upstream prematurely closed connection while reading response header from upstream
client: 10.21.46.50, request: "POST /api/v1/devices/batch/import?skip_existing=false"
upstream: "http://127.0.0.1:8000/api/v1/devices/batch/import"
```

**分析**: 
- Nginx报告后端突然关闭了连接
- 发生在批量导入API端点
- 不是Nginx本身的问题

#### 3.1.3 检查数据库日志
```bash
docker compose logs db --tail 50
```
**关键发现**:
```
Aborted connection 5 to db: 'switch_manage' user: 'root' host: '172.18.0.2' 
(Got an error reading communication packets)
```

**分析**:
- 数据库连接异常中断
- 后端进程在处理请求时崩溃或超时

#### 3.1.4 检查后端错误日志
```bash
docker compose exec app cat /var/log/supervisor/backend-error.log
```

**发现**: 后端服务有重启记录，但没有明显的Python异常堆栈

### 3.2 Phase 2: 根因分析

#### 3.2.1 502错误含义
HTTP 502 Bad Gateway 表示网关（Nginx）从上游服务器（后端）收到了无效响应。

#### 3.2.2 可能原因
1. **超时问题**: Nginx默认60秒超时，批量导入处理时间可能超过此限制
2. **后端崩溃**: 处理Excel文件时后端进程崩溃
3. **内存问题**: 大文件处理导致内存不足
4. **多Worker问题**: Uvicorn多worker模式可能导致请求处理不稳定

#### 3.2.3 验证假设
- 容器资源使用正常（内存使用44MB/1GB）
- 文件大小正常（测试文件<10MB）
- 数据库连接正常
- **最可能原因**: Nginx超时 + Uvicorn配置问题

### 3.3 Phase 3: 修复方案

#### 修复1: Nginx超时配置优化
**文件**: `docker/nginx.conf`

**修改前**:
```nginx
proxy_connect_timeout 60s;
proxy_send_timeout 60s;
proxy_read_timeout 60s;
```

**修改后**:
```nginx
# 超时设置 - 增加批量导入超时时间
proxy_connect_timeout 300s;
proxy_send_timeout 300s;
proxy_read_timeout 300s;

# 增加缓冲区大小，避免大响应被截断
proxy_buffering on;
proxy_buffer_size 4k;
proxy_buffers 8 4k;
proxy_busy_buffers_size 8k;
```

#### 修复2: Uvicorn配置优化
**文件**: `docker/supervisord.conf`

**修改前**:
```ini
command=uvicorn app.main:app --host 127.0.0.1 --port 8000 --workers 2
```

**修改后**:
```ini
; 使用单worker模式避免多进程问题，增加超时设置
command=uvicorn app.main:app --host 127.0.0.1 --port 8000 --workers 1 --timeout-keep-alive 300 --limit-max-requests 1000 --limit-max-requests-jitter 50

; 增加停止等待时间，确保请求处理完成
stopwaitsecs=30
stopsignal=TERM
```

#### 修复3: API端点增强
**文件**: `app/api/endpoints/devices.py`

**增加内容**:
- 文件大小限制（10MB）
- 详细日志记录
- 改进错误处理

```python
# 验证文件大小（限制10MB）
max_file_size = 10 * 1024 * 1024
file.file.seek(0, 2)
file_size = file.file.tell()
file.file.seek(0)

if file_size > max_file_size:
    raise HTTPException(
        status_code=status.HTTP_400_BAD_REQUEST,
        detail=f"文件大小超过限制（最大10MB）"
    )

# 详细日志
logger.info(f"开始批量导入设备，文件名: {file.filename}, 大小: {file_size} bytes")
```

---

## 4. 部署过程

### 4.1 代码提交
```bash
git add -A
git commit -m "fix(docker): 修复批量上传502错误"
git push origin master
```

### 4.2 服务器更新
```bash
cd /data/it-devops
git pull origin master
```

### 4.3 重新构建部署
```bash
docker compose down
docker compose build --no-cache
docker compose up -d
```

### 4.4 验证配置
```bash
# 验证Nginx配置
docker compose exec app cat /etc/nginx/nginx.conf | grep "proxy_read_timeout"
# 输出: proxy_read_timeout 300s;

# 验证Supervisord配置
docker compose exec app cat /etc/supervisor/conf.d/supervisord.conf | grep "workers"
# 输出: --workers 1
```

---

## 5. 验证结果

### 5.1 容器状态
```
NAME                    STATUS                    PORTS
switch_manage_db        Up 53 seconds (healthy)   3306/tcp
switch_manage_unified   Up 53 seconds (healthy)   0.0.0.0:80->80/tcp
```

### 5.2 配置确认
- ✅ Nginx超时时间: 300s
- ✅ Uvicorn workers: 1
- ✅ Uvicorn keep-alive超时: 300s
- ✅ 文件大小限制: 10MB

### 5.3 待用户验证
- [ ] 批量上传小文件（<100条记录）
- [ ] 批量上传大文件（>500条记录）
- [ ] 验证错误提示是否正常显示

---

## 6. 技术要点总结

### 6.1 502错误常见原因
| 原因 | 现象 | 解决方案 |
|------|------|----------|
| Nginx超时 | upstream timed out | 增加proxy_read_timeout |
| 后端崩溃 | upstream prematurely closed | 检查后端日志，修复崩溃原因 |
| 内存不足 | 容器OOM Killed | 增加容器内存限制 |
| 网络问题 | Connection refused | 检查网络连接和防火墙 |

### 6.2 Docker生产环境优化建议
1. **Nginx超时**: 根据业务需求设置合理的超时时间
2. **Uvicorn Workers**: 
   - CPU密集型: workers = CPU核心数
   - IO密集型: workers = 2-4 × CPU核心数
   - 内存受限: 使用单worker
3. **资源限制**: 设置合理的内存和CPU限制
4. **健康检查**: 配置适当的健康检查机制

### 6.3 排查工具链
```bash
# 查看容器状态
docker compose ps

# 查看日志
docker compose logs <service> -f --tail 100

# 进入容器
docker compose exec <service> sh

# 查看资源使用
docker stats --no-stream

# 检查配置文件
docker compose exec <service> cat <config_file>
```

---

## 7. 后续建议

### 7.1 监控建议
1. 添加Nginx错误率监控
2. 添加后端API响应时间监控
3. 添加容器资源使用监控

### 7.2 优化建议
1. 考虑使用异步处理大文件上传
2. 添加上传进度反馈
3. 实现断点续传功能

### 7.3 文档更新
1. 更新部署文档，包含超时配置说明
2. 添加故障排查手册
3. 记录性能基准测试数据

---

## 8. 参考文档

- [批量上传设备功能修复总结文档](../20260205/前端页面-设备管理-批量设备上传失效/修复总结文档.md)
- [Nginx代理超时配置](http://nginx.org/en/docs/http/ngx_http_proxy_module.html)
- [Uvicorn配置文档](https://www.uvicorn.org/settings/)
- [Docker Compose健康检查](https://docs.docker.com/compose/compose-file/compose-file-v3/#healthcheck)

---

**文档创建时间**: 2026-02-05  
**最后更新**: 2026-02-05  
**文档状态**: ✅ 已完成
