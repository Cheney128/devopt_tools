# 前端登录报错问题 - 项目知识文档

## 文档信息

- **文档版本**: v1.0（整合版）
- **整合日期**: 2026-02-05
- **问题类型**: 前端登录报错 / CORS跨域 / 密码验证
- **整合来源**: 11份相关文档
- **使用SKILL**: systematic-debugging, receiving-code-review, verification-before-completion, writing-plans, brainstorming, test-driven-development, finishing-a-development-branch, requesting-code-review

---

## 一、问题概述

### 1.1 问题现象

**发生时间**: 2026-02-05

**主要问题**: 前端页面登录时显示"网络连接失败，请检查网络"错误

**错误日志**:
```
[error] API Error:
at http://localhost:5173/src/api/index.js:39:12
[error] 登录失败:
at login (http://localhost:5173/src/stores/authStore.js:52:14)
[error] net::ERR_FAILED http://localhost:8000/api/v1/auth/login
at dispatchXhrRequest (http://localhost:5173/node_modules/.vite/deps/axios.js?v=6e544cd0:1695:12)
```

**后端错误日志（密码验证问题）**:
```
passlib.exc.UnknownHashError: hash could not be identified
File "app/core/security.py", line 41, in verify_password
```

### 1.2 问题分层

| 层级 | 问题类型 | 错误信息 | 根本原因 |
|------|----------|----------|----------|
| L1 | 后端密码验证 | `UnknownHashError` | 密码哈希方案不匹配 |
| L2 | 后端CORS配置 | CORS违规 | `allow_origins=["*"]` 与 `allow_credentials=True` 冲突 |
| L3 | 前端API配置 | `net::ERR_FAILED` | 前端使用完整URL直接跨域请求 |
| L4 | 代理配置不匹配 | 代理未生效 | Vite代理配置与前端baseURL不匹配 |

---

## 二、根本原因分析

### 2.1 密码验证问题（第一层）

**问题描述**: 
数据库中存储的用户密码哈希可能是使用 `bcrypt` 方案生成的，但当前代码只配置了 `pbkdf2_sha256` 方案。

**代码位置**: `app/core/security.py`

**修改前**:
```python
pwd_context = CryptContext(schemes=["pbkdf2_sha256"], deprecated="auto")
```

**修改后**:
```python
pwd_context = CryptContext(
    schemes=["pbkdf2_sha256", "bcrypt"],
    deprecated="auto",
    default="pbkdf2_sha256"
)
```

**修复原因**: 同时支持 `pbkdf2_sha256`（默认）和 `bcrypt`（向后兼容）两种方案，保持向后兼容性。

### 2.2 CORS配置问题（第二层）

**问题描述**:
后端CORS配置使用 `allow_origins=["*"]` 与 `allow_credentials=True` 组合，违反CORS规范。

**代码位置**: `app/config.py`

**修改前**:
```python
self.BACKEND_CORS_ORIGINS = ["*"]
```

**修改后**:
```python
self.BACKEND_CORS_ORIGINS = [
    "http://localhost:5173",  # Vite开发服务器
    "http://localhost:3000",  # 备用开发端口
]
```

**修复原因**:
1. 符合CORS规范：当 `allow_credentials=True` 时，不能使用通配符 `*`
2. 明确指定允许的源是更安全的做法
3. 这是导致 `net::ERR_FAILED` 的第一层原因

### 2.3 前端API配置问题（第三层）

**问题描述**:
前端使用完整URL `http://localhost:8000/api/v1` 直接请求后端，触发跨域，而非通过Vite代理。

**代码位置**: `frontend/.env`

**修改前**:
```
VITE_API_BASE_URL=http://localhost:8000/api/v1
```

**修改后**:
```
VITE_API_BASE_URL=/api/v1
```

**修复原因**:
1. 使用相对路径 `/api/v1`，请求会发送到同源地址 `http://localhost:5173/api/v1/...`
2. Vite代理配置拦截 `/api` 开头的请求
3. 代理将请求转发到 `http://localhost:8000`
4. 浏览器看到的是同源请求，不会触发CORS

---

## 三、修复方案

### 3.1 分层修复策略

基于多SKILL联合分析，采用**分层修复策略**：

1. **第一层修复**: 后端密码哈希配置（已完成）
2. **第二层修复**: 后端CORS配置（已完成）
3. **第三层修复**: 前端API配置（已完成）
4. **第四层修复**: 验证与优化（已完成）

### 3.2 修复文件清单

| 文件路径 | 修复内容 | 优先级 | 状态 |
|----------|----------|--------|------|
| `app/core/security.py` | 添加bcrypt支持 | P0 | ✅ 已完成 |
| `app/config.py` | 修复CORS配置 | P0 | ✅ 已完成 |
| `frontend/.env` | 修改API baseURL | P0 | ✅ 已完成 |

### 3.3 实施步骤

#### 步骤1: 修复密码哈希配置

**修改文件**: `app/core/security.py`

```python
# 密码哈希上下文
# 使用pbkdf2_sha256作为默认方案，同时支持bcrypt用于验证旧密码
# 避免bcrypt的72字节密码长度限制，同时保持向后兼容
pwd_context = CryptContext(
    schemes=["pbkdf2_sha256", "bcrypt"],
    deprecated="auto",
    default="pbkdf2_sha256"
)
```

#### 步骤2: 修复后端CORS配置

**修改文件**: `app/config.py`

```python
# CORS配置
self.BACKEND_CORS_ORIGINS = [
    "http://localhost:5173",  # Vite开发服务器
    "http://localhost:3000",  # 备用开发端口
]
```

#### 步骤3: 修复前端API配置

**修改文件**: `frontend/.env`

```
# 修改前
VITE_API_BASE_URL=http://localhost:8000/api/v1

# 修改后
VITE_API_BASE_URL=/api/v1
```

#### 步骤4: 重启服务

```bash
# 重启后端服务
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

# 重启前端服务
cd frontend
npm run dev
```

---

## 四、验证方法

### 4.1 配置验证

| 验证项 | 命令/方法 | 预期结果 |
|--------|-----------|----------|
| 后端CORS配置 | 读取 `app/config.py` | `BACKEND_CORS_ORIGINS` 为明确域名列表 |
| 前端环境配置 | 读取 `frontend/.env` | `VITE_API_BASE_URL=/api/v1` |
| Vite代理配置 | 读取 `frontend/vite.config.js` | 代理规则 `/api` 正确 |

### 4.2 功能验证

| 验证项 | 方法 | 预期结果 |
|--------|------|----------|
| 密码验证 | 登录测试 | 不再抛出 `UnknownHashError` |
| CORS响应头 | `curl -I -X OPTIONS http://localhost:8000/api/v1/auth/login -H "Origin: http://localhost:5173"` | 包含 `Access-Control-Allow-Origin: http://localhost:5173` |
| 登录请求路径 | Chrome DevTools Network | 请求URL为 `/api/v1/auth/login` |
| 请求状态码 | Chrome DevTools Network | 状态码为 200 |
| 浏览器控制台 | Chrome DevTools Console | 无CORS错误 |

### 4.3 验证命令

**检查后端CORS响应头**:
```bash
curl -I -X OPTIONS http://localhost:8000/api/v1/auth/login \
  -H "Origin: http://localhost:5173" \
  -H "Access-Control-Request-Method: POST"
```

**预期响应**:
```
HTTP/1.1 204 No Content
access-control-allow-origin: http://localhost:5173
access-control-allow-methods: POST, OPTIONS
access-control-allow-headers: *
```

**检查后端服务状态**:
```bash
curl http://localhost:8000/health
```

**预期响应**:
```json
{"status":"healthy"}
```

**检查前端环境变量**:
在浏览器控制台执行:
```javascript
import.meta.env.VITE_API_BASE_URL
// 应该返回: "/api/v1"
```

---

## 五、技术原理

### 5.1 Passlib CryptContext 多方案配置

```python
CryptContext(
    schemes=["pbkdf2_sha256", "bcrypt"],  # 支持的哈希方案列表
    deprecated="auto",                     # 自动处理已弃用方案
    default="pbkdf2_sha256"               # 新密码使用的默认方案
)
```

**工作原理**:
1. **验证时**: Passlib 自动识别哈希字符串的格式，使用对应的方案验证
2. **哈希时**: 使用 `default` 指定的方案生成新哈希
3. **升级**: 可以在验证成功后自动将旧方案哈希升级为新方案（可选配置）

### 5.2 CORS规范

**跨域定义**: 当请求的协议、域名或端口与当前页面不同时，即为跨域。

**当前情况**:
- 前端页面: `http://localhost:5173`
- 后端API: `http://localhost:8000`
- 端口不同（5173 vs 8000）→ 跨域

**修复方案对比**:

| 方案 | 原理 | 优点 | 缺点 |
|------|------|------|------|
| CORS配置 | 后端允许跨域 | 直接 | 浏览器限制多，易缓存错误 |
| Vite代理 | 前端代理转发 | 无跨域限制，开发标准 | 仅适用于开发环境 |

### 5.3 Vite代理工作原理

```
浏览器 → localhost:5173/api/v1/auth/login
         ↓
       Vite Dev Server
         ↓ (匹配 /api 规则)
       转发到 localhost:8000/api/v1/auth/login
         ↓
       后端服务
```

代理在服务器端进行请求转发，浏览器不知道实际的后端地址，因此不会触发跨域限制。

### 5.4 请求流程对比

#### 修复前：直接跨域请求（问题流程）

```
浏览器 (localhost:5173)
  ↓ axios.post('http://localhost:8000/api/v1/auth/login')
  ↓ 跨域请求（端口5173 → 8000）
  ↓ 触发CORS预检
  ↓ ❌ net::ERR_FAILED
```

#### 修复后：通过代理同源请求（正常流程）

```
浏览器 (localhost:5173)
  ↓ axios.post('/api/v1/auth/login')  // 相对路径
  ↓ 同源请求（端口5173 → 5173）
  ↓ Vite代理拦截 /api/*
  ↓ 转发到 localhost:8000
  ↓ ✅ 正常响应
```

---

## 六、风险评估

### 6.1 潜在风险

| 风险 | 可能性 | 影响 | 缓解措施 | 状态 |
|------|--------|------|---------|------|
| 旧密码无法验证 | 低 | 高 | 已添加bcrypt支持 | ✅ 已缓解 |
| CORS配置违规 | 低 | 高 | 已修改为明确域名 | ✅ 已缓解 |
| 前端请求仍跨域 | 低 | 中 | 已修改为相对路径 | ✅ 已缓解 |
| 环境变量未生效 | 低 | 中 | 已重启前端服务 | ✅ 已缓解 |
| 浏览器缓存问题 | 低 | 低 | 建议硬性刷新 | ✅ 已提示 |

### 6.2 注意事项

1. **环境变量修改后必须重启**
   - Vite在启动时加载`.env`文件，运行时不会重新加载
   - 修改后必须停止当前服务（Ctrl+C）并重新运行`npm run dev`

2. **浏览器状态**
   - 清除浏览器缓存或使用无痕模式
   - 关闭可能干扰的浏览器扩展（如广告拦截器）
   - 建议使用Chrome DevTools的Network标签监控请求

3. **后端服务状态**
   - 确认后端服务正在运行
   - 可以通过`curl http://localhost:8000/health`快速验证

---

## 七、生产环境配置

### 7.1 生产环境部署架构

**标准生产部署架构**:
```
用户请求
    ↓
Nginx 反向代理 (端口80/443)
    ↓
┌─────────────────────────────────────┐
│  静态资源: / -> 前端Build产物        │
│  API代理: /api/* -> 后端服务:8000    │
└─────────────────────────────────────┘
```

**关键配置** (Nginx):
```nginx
server {
    listen 80;
    server_name your-domain.com;

    # 前端静态资源
    location / {
        root /var/www/switch-manage/dist;
        try_files $uri $uri/ /index.html;
    }

    # API代理 - 与Vite代理原理相同
    location /api/ {
        proxy_pass http://localhost:8000/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 7.2 开发环境与生产环境对比

| 特性 | 开发环境 | 生产环境 |
|------|----------|----------|
| 代理机制 | Vite开发服务器 | Nginx反向代理 |
| 前端地址 | localhost:5173 | your-domain.com |
| 后端地址 | localhost:8000 (通过代理隐藏) | localhost:8000 (通过代理隐藏) |
| 跨域处理 | 代理转发（同源） | 代理转发（同源） |
| CORS配置 | 通常不需要 | 通常不需要 |
| 配置位置 | vite.config.js | nginx.conf |

### 7.3 为什么生产环境不需要担心跨域

1. **统一入口点**: 用户通过Nginx访问所有资源（前端页面和API），浏览器看到的是同源请求
2. **服务器端转发**: Nginx在服务器端将 `/api/*` 请求转发到后端，浏览器不知情
3. **安全优势**: 后端服务不需要暴露CORS，可以设置为仅允许Nginx访问
4. **性能优势**: 静态资源可以直接从Nginx提供，减少网络跳转

---

## 八、决策记录

### 8.1 决策1：密码哈希方案配置

**决策日期**: 2026-02-05

**决策背景**: 登录时报 `UnknownHashError: hash could not be identified` 错误

**决策内容**: 修改 `CryptContext` 配置，同时支持 `pbkdf2_sha256` 和 `bcrypt` 两种方案

**决策原因**:
1. 数据库中存储的密码哈希可能是使用bcrypt方案生成的
2. 当前代码只配置了pbkdf2_sha256方案，无法识别旧密码哈希
3. 同时支持多种方案可以保持向后兼容性

**决策结果**: 修复后密码验证功能正常，旧用户可以正常登录

### 8.2 决策2：后端CORS配置修复

**决策日期**: 2026-02-05

**决策背景**: 后端CORS配置使用 `allow_origins=["*"]` 与 `allow_credentials=True` 组合，违反CORS规范

**决策内容**: 将 `BACKEND_CORS_ORIGINS` 从 `["*"]` 修改为明确指定前端地址 `["http://localhost:5173", "http://localhost:3000"]`

**决策原因**:
1. CORS规范要求：当 `Access-Control-Allow-Credentials` 为 true 时，`Access-Control-Allow-Origin` 不能使用通配符 `*`
2. 明确指定允许的源是更安全的做法
3. 这是导致 `net::ERR_FAILED` 错误的根本原因

**决策结果**: 修复后前端可以正常跨域访问后端API

### 8.3 决策3：前端API配置修复

**决策日期**: 2026-02-05

**决策背景**: 前端登录报错 `net::ERR_FAILED`，经多SKILL联合分析发现根本原因是前端API配置使用完整URL直接跨域请求后端

**决策内容**: 将前端 `VITE_API_BASE_URL` 从 `http://localhost:8000/api/v1` 修改为 `/api/v1`

**决策原因**:
1. 使用相对路径可以让请求经过Vite代理，避免浏览器跨域限制
2. 代理在服务器端转发请求，浏览器看到的是同源请求
3. 这是开发环境的标准做法，比直接配置CORS更可靠

**决策结果**: 修复后前端请求将通过Vite代理转发到后端，从根本上解决跨域问题

---

## 九、变更记录

### 9.1 变更1：密码哈希配置

- **变更的日期**: 2026-02-05 15:40
- **变更的文件**: `app/core/security.py`
- **变更的位置**: 19-26
- **变更的内容**:
  - 修改前: `pwd_context = CryptContext(schemes=["pbkdf2_sha256"], deprecated="auto")`
  - 修改后: 
    ```python
    pwd_context = CryptContext(
        schemes=["pbkdf2_sha256", "bcrypt"],
        deprecated="auto",
        default="pbkdf2_sha256"
    )
    ```
- **变更的原因**: 修复登录失败问题。数据库中存储的密码哈希可能是使用bcrypt方案生成的，但当前代码只配置了pbkdf2_sha256方案，导致passlib无法识别旧密码哈希，抛出UnknownHashError错误。修改后同时支持两种方案，保持向后兼容性。

### 9.2 变更2：后端CORS配置

- **变更的日期**: 2026-02-05
- **变更的文件**: `app/config.py`
- **变更的位置**: BACKEND_CORS_ORIGINS
- **变更的内容**:
  - 修改前: `self.BACKEND_CORS_ORIGINS = ["*"]`
  - 修改后: 
    ```python
    self.BACKEND_CORS_ORIGINS = [
        "http://localhost:5173",
        "http://localhost:3000",
    ]
    ```
- **变更的原因**: 修复CORS配置违规问题。当 `allow_credentials=True` 时，不能使用通配符 `*`，必须明确指定允许的源。

### 9.3 变更3：前端API配置

- **变更的日期**: 2026-02-05
- **变更的文件**: `frontend/.env`
- **变更的位置**: VITE_API_BASE_URL
- **变更的内容**:
  - 修改前: `VITE_API_BASE_URL=http://localhost:8000/api/v1`
  - 修改后: `VITE_API_BASE_URL=/api/v1`
- **变更的原因**: 修复前端登录报错问题，使请求通过Vite代理转发，避免跨域。

---

## 十、相关文件引用

| 文件 | 作用 | 是否需要修改 |
|------|------|--------------|
| `app/core/security.py` | 密码哈希配置 | ✅ 已修复 |
| `app/config.py` | 后端CORS配置源 | ✅ 已修复 |
| `app/main.py` | CORS中间件配置 | ❌ 否（配置正确） |
| `frontend/.env` | 前端环境变量配置 | ✅ 已修复 |
| `frontend/vite.config.js` | Vite代理配置 | ❌ 否（配置正确） |
| `frontend/src/api/index.js` | Axios实例配置 | ❌ 否（逻辑正确） |

---

## 十一、附录

### 11.1 验证命令速查

| 验证项 | 命令 | 预期结果 |
|-------|------|---------|
| CORS响应头 | `curl -I -X OPTIONS http://localhost:8000/api/v1/auth/login -H "Origin: http://localhost:5173"` | 包含 `Access-Control-Allow-Origin: http://localhost:5173` |
| 后端健康检查 | `curl http://localhost:8000/health` | 返回 `{"status":"healthy"}` |
| 端口连通性 | `Test-NetConnection -ComputerName localhost -Port 8000` | TCPTestSucceeded: True |
| 前端环境变量 | 在浏览器控制台执行 `import.meta.env.VITE_API_BASE_URL` | 返回 `"/api/v1"` |

### 11.2 常见问题解答

**Q1: 修改`.env`文件后需要重启前端服务吗？**

**答**: 是的，必须重启。Vite在启动时加载环境变量，运行时不会感知`.env`文件的变化。

**Q2: 如果我不想使用代理，可以直接访问后端吗？**

**答**: 可以，但需要确保：
1. 后端CORS配置正确（已配置）
2. 浏览器没有缓存CORS错误
3. 没有浏览器扩展阻止跨域请求
4. 使用完整URL而非相对路径

**Q3: 修改后之前的CORS错误还会出现吗？**

**答**: 不会。因为请求现在通过Vite代理，浏览器视为同源请求，不会触发CORS检查。

**Q4: 生产环境也需要修改这个配置吗？**

**答**: 不需要。生产环境通过Nginx代理，天然避免跨域问题。本方案只针对开发环境。

**Q5: 代理配置中的`changeOrigin`参数有什么作用？**

**答**: `changeOrigin: true`会将请求头中的`Host`字段修改为目标服务器的Host，帮助后端正确识别请求来源。

### 11.3 文档版本历史

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| v1.0 | 2026-02-05 | 整合所有相关文档为项目知识文档 |

---

*文档创建时间: 2026-02-05*
*整合方法: 多SKILL联合分析（systematic-debugging + receiving-code-review + verification-before-completion + writing-plans + brainstorming + test-driven-development + finishing-a-development-branch + requesting-code-review）*
*创建人: AI Assistant*
