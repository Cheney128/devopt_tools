# 交换机批量管理与巡检系统 - 项目架构分析

> 分析日期：2026-02-02
> 分析工具：SKILL (brainstorming, writing-plans, development-documentation-archiving)

---

## 1. 项目概述

### 1.1 项目背景
本项目是一个用于批量管理和巡检交换机的Web应用，旨在简化网络设备的管理流程，提高网络运维效率。系统支持批量配置交换机基本信息、端口信息、VLAN信息等，同时提供批量巡检功能，实时获取交换机的运行状态和性能指标。

### 1.2 核心功能
1. **批量管理交换机**：配置基本信息、端口信息、VLAN信息等
2. **批量巡检交换机**：获取运行状态、性能指标等信息
3. **直接设备配置采集**：通过Netmiko直接登录设备获取配置
4. **配置版本管理**：自动保存配置变更，支持版本递增和变更描述
5. **Git集成**：将配置自动推送到GitHub/GitLab仓库
6. **配置差异比较**：支持查看不同版本配置的差异

---

## 2. 系统架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              用户层 (User Layer)                             │
│                         浏览器 / Web Client                                  │
└─────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              前端层 (Frontend Layer)                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │   Vue.js 3   │  │ Element Plus │  │  Vue Router  │  │    Pinia     │     │
│  │   (框架)     │  │  (UI组件)    │  │   (路由)     │  │  (状态管理)   │     │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘     │
└─────────────────────────────────────────────────────────────────────────────┘
                                       │ HTTP/REST API
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              后端层 (Backend Layer)                          │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         FastAPI (Web框架)                            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│  ┌──────────────┬──────────────┬──────────────┬──────────────┬──────────┐  │
│  │   API路由    │   业务逻辑   │   数据模型   │   数据验证   │  服务层   │  │
│  │  (endpoints) │  (services)  │   (models)   │  (schemas)   │          │  │
│  └──────────────┴──────────────┴──────────────┴──────────────┴──────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                                       │
                    ┌──────────────────┼──────────────────┐
                    ▼                  ▼                  ▼
┌──────────────────────┐  ┌──────────────────────┐  ┌──────────────────────┐
│    数据层 (Data)      │  │   设备层 (Devices)    │  │   集成层 (Integration) │
│  ┌────────────────┐  │  │  ┌────────────────┐  │  │  ┌────────────────┐  │
│  │    MySQL 5.7   │  │  │  │   Netmiko      │  │  │  │    Git仓库      │  │
│  │   (数据库)      │  │  │  │  (SSH/Telnet)  │  │  │  │(GitHub/GitLab) │  │
│  └────────────────┘  │  │  └────────────────┘  │  │  └────────────────┘  │
│  ┌────────────────┐  │  │  ┌────────────────┐  │  │                      │
│  │   SQLAlchemy   │  │  │  │   Paramiko     │  │  │                      │
│  │    (ORM)       │  │  │  │   (SSH协议)     │  │  │                      │
│  └────────────────┘  │  │  └────────────────┘  │  │                      │
└──────────────────────┘  └──────────────────────┘  └──────────────────────┘
```

### 2.2 分层架构说明

#### 2.2.1 前端层 (Frontend Layer)
- **框架**：Vue.js 3 (Composition API)
- **UI组件库**：Element Plus 2.13.1
- **路由管理**：Vue Router 4.6.4
- **状态管理**：Pinia 3.0.4
- **HTTP客户端**：Axios 1.13.2
- **构建工具**：Vite 7.2.4

#### 2.2.2 后端层 (Backend Layer)
- **Web框架**：FastAPI 0.104.1
- **ASGI服务器**：Uvicorn 0.24.0
- **ORM框架**：SQLAlchemy 1.4.51
- **数据验证**：Pydantic 2.5.2
- **环境管理**：python-dotenv 1.0.0

#### 2.2.3 数据层 (Data Layer)
- **数据库**：MySQL 5.7
- **数据库驱动**：PyMySQL 1.1.0
- **ORM映射**：SQLAlchemy declarative_base

#### 2.2.4 设备层 (Device Layer)
- **设备连接**：Netmiko 4.1.0
- **SSH协议**：Paramiko 3.4.0
- **支持协议**：SSH、Telnet

#### 2.2.5 集成层 (Integration Layer)
- **版本控制**：GitPython 3.1.43
- **Git仓库**：GitHub/GitLab

---

## 3. 模块划分

### 3.1 后端模块结构

```
app/
├── api/                          # API层
│   ├── __init__.py              # 路由聚合
│   └── endpoints/               # API端点
│       ├── devices.py           # 设备管理API
│       ├── ports.py             # 端口管理API
│       ├── vlans.py             # VLAN管理API
│       ├── inspections.py       # 巡检管理API
│       ├── configurations.py    # 配置管理API
│       ├── device_collection.py # 设备采集API
│       ├── git_configs.py       # Git配置API
│       ├── command_templates.py # 命令模板API
│       └── command_history.py   # 命令历史API
│
├── services/                     # 业务逻辑层
│   ├── netmiko_service.py       # 设备连接服务
│   ├── git_service.py           # Git操作服务
│   ├── backup_scheduler.py      # 备份调度服务
│   ├── excel_service.py         # Excel处理服务
│   └── ssh_connection_pool.py   # SSH连接池
│
├── models/                       # 数据模型层
│   ├── __init__.py
│   └── models.py                # SQLAlchemy模型定义
│
├── schemas/                      # 数据验证层
│   └── schemas.py               # Pydantic模型定义
│
├── config.py                     # 应用配置
├── main.py                       # 应用入口
└── db_update.py                  # 数据库更新脚本
```

### 3.2 前端模块结构

```
frontend/src/
├── api/                          # API服务层
│   ├── index.js                 # Axios配置
│   └── deviceCollection.js      # 设备采集API
│
├── views/                        # 页面视图层
│   ├── HomeView.vue             # 首页
│   ├── DeviceManagement.vue     # 设备管理
│   ├── PortManagement.vue       # 端口管理
│   ├── VLANManagement.vue       # VLAN管理
│   ├── InspectionManagement.vue # 巡检管理
│   ├── ConfigurationManagement.vue # 配置管理
│   ├── DeviceCollection.vue     # 设备采集
│   └── GitConfigManagement.vue  # Git配置管理
│
├── components/                   # 公共组件
│   └── HelloWorld.vue
│
├── router/                       # 路由配置
│   └── index.js
│
├── stores/                       # 状态管理
│   ├── deviceStore.js
│   └── deviceCollectionStore.js
│
├── assets/                       # 静态资源
├── App.vue                       # 根组件
└── main.js                       # 入口文件
```

---

## 4. 数据流架构

### 4.1 请求处理流程

```
┌─────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────┐
│  Client │───▶│   Nginx     │───▶│   FastAPI   │───▶│   Service   │───▶│  MySQL  │
│ (Browser)│    │   (Port 80) │    │  (Port 8000)│    │   Layer     │    │(Port    │
└─────────┘    └─────────────┘    └─────────────┘    └─────────────┘    │ 3306)   │
                                              │                          └─────────┘
                                              ▼
                                       ┌─────────────┐
                                       │   Device    │
                                       │  (Netmiko)  │
                                       └─────────────┘
```

### 4.2 设备数据采集流程

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   用户请求   │───▶│   API端点    │───▶│  Netmiko    │───▶│   网络设备   │
│ (采集配置)   │    │(device_coll)│    │   Service   │    │  (Switch)   │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                              │
                                              ▼
                                       ┌─────────────┐
                                       │   解析输出   │
                                       │(Parse Output)│
                                       └─────────────┘
                                              │
                    ┌─────────────────────────┼─────────────────────────┐
                    ▼                         ▼                         ▼
             ┌─────────────┐          ┌─────────────┐          ┌─────────────┐
             │   MySQL     │          │    Git      │          │   返回结果   │
             │  (存储数据)  │          │  (版本控制)  │          │  (给前端)   │
             └─────────────┘          └─────────────┘          └─────────────┘
```

---

## 5. 核心组件说明

### 5.1 NetmikoService (设备连接服务)

**职责**：
- 管理设备SSH/Telnet连接
- 执行设备命令
- 解析设备输出
- 支持多厂商适配

**支持厂商**：
- Cisco (IOS, IOS-XE, NX-OS, ASA)
- 华为 (VRP)
- H3C (Comware)
- 锐捷 (RuijieOS)

**核心方法**：
- `connect_to_device()` - 建立设备连接
- `execute_command()` - 执行设备命令
- `collect_device_version()` - 采集版本信息
- `collect_device_serial()` - 采集序列号
- `collect_interfaces_info()` - 采集接口信息
- `collect_mac_table()` - 采集MAC地址表
- `collect_running_config()` - 采集运行配置

### 5.2 GitService (Git操作服务)

**职责**：
- 管理Git仓库连接
- 提交配置变更
- 版本控制操作

**核心功能**：
- 多仓库配置支持
- 自动提交配置
- 连接测试

### 5.3 BackupScheduler (备份调度服务)

**职责**：
- 定时备份任务管理
- 调度策略配置
- 任务执行监控

**支持调度类型**：
- hourly (每小时)
- daily (每天)
- monthly (每月)

---

## 6. 扩展性设计

### 6.1 水平扩展
- 支持Docker容器化部署
- 可水平扩展后端服务实例
- 数据库可配置主从复制

### 6.2 功能扩展
- 模块化API设计，易于添加新功能
- 插件化服务架构
- 命令模板支持自定义扩展

### 6.3 厂商扩展
- 设备类型映射表支持新增厂商
- 命令映射表支持自定义命令
- 解析器支持扩展

---

## 7. 安全设计

### 7.1 通信安全
- 支持SSH加密连接设备
- 支持SSH密钥认证
- API支持HTTPS (需配置)

### 7.2 数据安全
- 数据库密码加密存储
- 设备凭据安全存储
- Git凭据加密处理

### 7.3 访问控制
- CORS跨域配置
- 可扩展用户认证机制

---

## 8. 监控与日志

### 8.1 日志记录
- 设备连接日志
- 命令执行日志
- 错误日志记录

### 8.2 健康检查
- `/health` 端点健康检查
- 数据库连接监控
- 设备连接状态监控

---

## 9. 总结

本项目采用现代化的前后端分离架构，后端使用FastAPI提供高性能异步API服务，前端使用Vue 3构建响应式用户界面。系统通过Netmiko实现与网络设备的直接通信，支持多厂商设备的统一管理。整体架构设计清晰，模块化程度高，具有良好的可扩展性和可维护性。

**架构优势**：
1. **高性能**：FastAPI异步处理，支持高并发
2. **易扩展**：模块化设计，易于功能扩展
3. **易维护**：清晰的分层架构，代码结构清晰
4. **易部署**：Docker容器化，支持一键部署
5. **多厂商**：支持主流网络设备厂商
