# 部署架构分析

## 1. 部署架构概述

### 1.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              交换机批量管理与巡检系统                              │
│                              Docker Compose 部署架构                              │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌──────────────────┐                                                           │
│  │   外部用户访问    │                                                           │
│  └────────┬─────────┘                                                           │
│           │ HTTP 80                                                             │
│           ▼                                                                     │
│  ┌──────────────────────────────────────────────────────────────────────┐       │
│  │                        Frontend 服务 (Nginx)                          │       │
│  │  ┌────────────────────────────────────────────────────────────────┐  │       │
│  │  │  - 静态资源服务 (Vue.js 构建产物)                               │  │       │
│  │  │  - API 请求反向代理到后端                                       │  │       │
│  │  │  - 端口映射: 80:80                                             │  │       │
│  │  │  - 容器名称: switch_manage_frontend                            │  │       │
│  │  └────────────────────────────────────────────────────────────────┘  │       │
│  └───────────────────────────────┬──────────────────────────────────────┘       │
│                                  │ /api/*                                        │
│                                  ▼                                               │
│  ┌──────────────────────────────────────────────────────────────────────┐       │
│  │                        Backend 服务 (FastAPI)                         │       │
│  │  ┌────────────────────────────────────────────────────────────────┐  │       │
│  │  │  - Python 3.9 + FastAPI 应用                                   │  │       │
│  │  │  - RESTful API 服务                                            │  │       │
│  │  │  - 端口映射: 8000:8000                                         │  │       │
│  │  │  - 容器名称: switch_manage_backend                             │  │       │
│  │  │  - 热重载模式 (--reload)                                       │  │       │
│  │  └────────────────────────────────────────────────────────────────┘  │       │
│  └──────┬─────────────────────────┘                                              │
│         │                                                                        │
│         │ MySQL                                                                  │
│         ▼                                                                          │
│  ┌──────────────────┐                                                             │
│  │   DB 服务         │                                                             │
│  │  (MySQL 5.7)      │                                                             │
│  │                   │                                                             │
│  │  - 端口: 3306     │                                                             │
│  │  - 数据持久化     │                                                             │
│  │  - 容器名:        │                                                             │
│  │    switch_manage_ │                                                             │
│  │    db             │                                                             │
│  └──────────────────┘                                                             │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                           Docker 网络                                   │    │
│  │                    switch_manage_network (bridge)                       │    │
│  │              - 所有服务通过内部网络通信                                  │    │
│  │              - 服务间通过容器名进行 DNS 解析                             │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                           数据卷                                        │    │
│  │  - mysql_data: MySQL 数据库持久化存储                                    │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 服务依赖关系

```
                    ┌─────────────────┐
                    │   Frontend      │
                    │   (Nginx 80)    │
                    └────────┬────────┘
                             │ depends_on
                             ▼
                    ┌─────────────────┐
                    │    Backend      │
                    │  (FastAPI 8000) │
                    └────────┬────────┘
                             │
            ┌────────────────┼────────────────┐
            │                                 │
            ▼                                 ▼
    ┌───────────────┐               ┌──────────────┐
    │      DB       │               │ 外部网络设备  │
    │  (MySQL 3306) │               │   (SSH)      │
    └───────────────┘               └──────────────┘
```

## 2. Docker Compose 配置详解

### 2.1 服务配置

#### 2.1.1 Backend 服务

```yaml
backend:
  build:
    context: .
    dockerfile: Dockerfile
  container_name: switch_manage_backend
  ports:
    - "8000:8000"
  volumes:
    - .:/app  # 开发模式挂载源码
  environment:
    - DATABASE_URL=mysql://admin:password@db:3306/switch_manage
  depends_on:
    - db
  networks:
    - switch_manage_network
```

**配置说明：**
- **构建上下文**：项目根目录
- **端口映射**：主机 8000 → 容器 8000
- **卷挂载**：开发模式下挂载源码实现热重载
- **环境变量**：
  - `DATABASE_URL`: MySQL 连接字符串，使用服务名 `db` 作为主机名
- **依赖服务**：数据库必须先启动

#### 2.1.2 Frontend 服务

```yaml
frontend:
  build:
    context: ./frontend
    dockerfile: Dockerfile.frontend
  container_name: switch_manage_frontend
  ports:
    - "80:80"
  depends_on:
    - backend
  networks:
    - switch_manage_network
```

**配置说明：**
- **构建上下文**：frontend 目录
- **端口映射**：主机 80 → 容器 80（标准 HTTP 端口）
- **多阶段构建**：先构建 Vue 应用，再使用 Nginx 托管
- **依赖服务**：后端服务必须先启动

#### 2.1.3 MySQL 数据库服务

```yaml
db:
  image: mysql:5.7
  container_name: switch_manage_db
  ports:
    - "3306:3306"
  environment:
    - MYSQL_ROOT_PASSWORD=password
    - MYSQL_DATABASE=switch_manage
    - MYSQL_USER=admin
    - MYSQL_PASSWORD=password
  volumes:
    - mysql_data:/var/lib/mysql
  networks:
    - switch_manage_network
```

**配置说明：**
- **镜像版本**：MySQL 5.7（稳定版本）
- **端口映射**：主机 3306 → 容器 3306
- **环境变量**：
  - `MYSQL_ROOT_PASSWORD`: root 密码
  - `MYSQL_DATABASE`: 自动创建的数据库
  - `MYSQL_USER/MYSQL_PASSWORD`: 应用数据库用户
- **数据持久化**：使用命名卷 `mysql_data`

### 2.2 网络和卷配置

```yaml
volumes:
  mysql_data:       # MySQL 数据持久化

networks:
  switch_manage_network:
    driver: bridge  # 桥接网络模式
```

## 3. Dockerfile 详解

### 3.1 后端 Dockerfile

**文件位置**：`Dockerfile`

```dockerfile
# 基础镜像
FROM python:3.9-slim

# 设置工作目录
WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    gcc \
    default-libmysqlclient-dev \
    net-tools \
    && rm -rf /var/lib/apt/lists/*

# 复制依赖文件
COPY requirements.txt .

# 安装Python依赖（使用清华镜像加速）
RUN pip install --no-cache-dir -r requirements.txt \
    -i https://pypi.tuna.tsinghua.edu.cn/simple

# 复制应用代码
COPY . .

# 暴露端口
EXPOSE 8000

# 启动命令（开发模式带热重载）
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", \
     "--port", "8000", "--reload"]
```

**构建优化点：**
1. **多阶段构建**：虽然当前未使用，但可考虑分离构建和运行阶段
2. **依赖缓存**：先复制 requirements.txt，利用 Docker 层缓存
3. **镜像加速**：使用清华 PyPI 镜像加速依赖安装
4. **系统依赖**：安装 MySQL 客户端开发库和编译工具

### 3.2 前端 Dockerfile

**文件位置**：`frontend/Dockerfile.frontend`

```dockerfile
# 构建阶段
FROM node:16-alpine as build

WORKDIR /app

# 复制依赖文件
COPY package.json package-lock.json ./

# 安装依赖（使用淘宝镜像加速）
RUN npm install --registry=https://registry.npmmirror.com

# 复制源代码
COPY . .

# 构建前端应用
RUN npm run build

# 生产阶段
FROM nginx:alpine

# 复制构建产物到 Nginx
COPY --from=build /app/dist /usr/share/nginx/html

# 复制 Nginx 配置
COPY nginx.conf /etc/nginx/conf.d/default.conf

# 暴露端口
EXPOSE 80

# 启动 Nginx
CMD ["nginx", "-g", "daemon off;"]
```

**多阶段构建优势：**
1. **减小镜像体积**：最终镜像只包含 Nginx 和静态文件，约 20-30MB
2. **安全性**：不包含 Node.js 和构建工具
3. **构建缓存**：依赖安装层可独立缓存

## 4. Nginx 配置详解

**文件位置**：`frontend/nginx.conf`

```nginx
server {
    listen 80;
    server_name localhost;

    # 前端静态资源
    location / {
        root /usr/share/nginx/html;
        index index.html index.htm;
        try_files $uri $uri/ /index.html;  # Vue Router 历史模式支持
    }

    # API 反向代理
    location /api/ {
        proxy_pass http://backend:8000/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 错误页面
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
    }
}
```

**配置要点：**
1. **单页应用支持**：`try_files` 指令支持 Vue Router 历史模式
2. **API 代理**：所有 `/api/` 请求转发到后端服务
3. **请求头传递**：保留原始请求信息（IP、协议等）
4. **服务发现**：使用容器名 `backend` 进行 DNS 解析

## 5. 环境配置管理

### 5.1 环境变量配置

**文件位置**：`.env.example`

```bash
# 数据库连接信息
DATABASE_URL=mysql://root:1qaz@WSX@10.21.65.20:3307/switch_manage

# 应用配置
APP_NAME=Switch Manage System
APP_VERSION=1.0.0
DEBUG=True
```

### 5.2 配置加载机制

**文件位置**：`app/config.py`

```python
from dotenv import load_dotenv
import os

# 加载 .env 文件
load_dotenv()

class Settings:
    def __init__(self):
        # 应用基本配置
        self.APP_NAME = os.getenv('APP_NAME', 'Switch Manage System')
        self.APP_VERSION = os.getenv('APP_VERSION', '1.0.0')
        self.DEBUG = os.getenv('DEBUG', 'True').lower() == 'true'

        # 数据库配置
        self.DATABASE_URL = os.getenv('DATABASE_URL')

        # API配置
        self.API_V1_STR = os.getenv('API_V1_STR', '/api/v1')

        # CORS配置
        self.BACKEND_CORS_ORIGINS = ["*"]

# 全局配置实例
settings = Settings()
```

**配置管理策略：**
1. **环境隔离**：开发、测试、生产使用不同的 .env 文件
2. **默认值**：提供合理的默认配置
3. **类型转换**：自动转换布尔值等类型
4. **集中管理**：所有配置在一个类中管理

## 6. 部署流程

### 6.1 开发环境部署

```bash
# 1. 克隆代码
git clone <repository-url>
cd switch_manage

# 2. 创建环境配置文件
cp .env.example .env
# 编辑 .env 文件，配置数据库等信息

# 3. 启动所有服务
docker-compose up -d

# 4. 查看服务状态
docker-compose ps

# 5. 查看日志
docker-compose logs -f backend
```

### 6.2 生产环境部署

```bash
# 1. 拉取最新代码
git pull origin main

# 2. 重新构建镜像
docker-compose build

# 3. 停止旧服务
docker-compose down

# 4. 启动新服务
docker-compose up -d

# 5. 健康检查
curl http://localhost/api/v1/health
```

### 6.3 常用运维命令

```bash
# 查看所有容器状态
docker-compose ps

# 查看服务日志
docker-compose logs -f [service_name]

# 重启服务
docker-compose restart [service_name]

# 进入容器
docker-compose exec backend bash

# 数据库备份
docker-compose exec db mysqldump -u admin -p switch_manage > backup.sql

# 查看资源使用
docker stats
```

## 7. 部署架构特点

### 7.1 优势

1. **一键部署**：`docker-compose up -d` 启动所有服务
2. **环境一致性**：开发、测试、生产环境完全一致
3. **服务隔离**：每个服务独立运行，互不影响
4. **易于扩展**：可单独扩容某个服务
5. **数据持久化**：数据库和配置数据持久化存储
6. **热重载**：开发模式下代码修改自动生效

### 7.2 注意事项

1. **安全性**：
   - 生产环境应修改默认密码
   - 限制端口暴露范围
   - 使用 HTTPS 替代 HTTP

2. **性能优化**：
   - 后端可考虑使用 Gunicorn + Uvicorn 工作进程
   - Nginx 可启用 Gzip 压缩
   - 添加 Redis 缓存层

3. **监控告警**：
   - 添加容器健康检查
   - 集成 Prometheus + Grafana 监控
   - 配置日志收集（ELK Stack）

4. **备份策略**：
   - 定期备份 MySQL 数据
   - 异地备份重要数据

## 8. 总结

本系统采用 Docker Compose 进行容器化部署，具有以下特点：

1. **微服务架构**：3 个独立服务（Backend、Frontend、DB）
2. **分层构建**：前端使用多阶段构建优化镜像体积
3. **服务发现**：通过 Docker 网络实现服务间通信
4. **数据持久化**：使用命名卷确保数据安全
5. **配置外部化**：通过环境变量灵活配置

这种部署架构适合中小规模部署，如需大规模部署可考虑：
- Kubernetes 编排
- 服务网格（Istio）
- 分布式追踪
- 自动扩缩容
