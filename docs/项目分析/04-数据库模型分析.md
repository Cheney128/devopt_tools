# 交换机批量管理与巡检系统 - 数据库模型分析

> 分析日期：2026-02-02
> 分析工具：SKILL (brainstorming, writing-plans, development-documentation-archiving)

---

## 1. 数据库架构概览

### 1.1 数据库选型
- **数据库**: MySQL 5.7
- **ORM**: SQLAlchemy 1.4.51
- **驱动**: PyMySQL 1.1.0
- **字符集**: UTF-8

### 1.2 数据库关系图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           数据库实体关系图 (ER Diagram)                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────┐                                                           │
│  │   devices    │                                                           │
│  │  (设备信息表)  │                                                           │
│  ├──────────────┤                                                           │
│  │ PK id        │◄─────────────────────────────────────────────────┐        │
│  │    hostname  │                                                  │        │
│  │    ip_address│                                                  │        │
│  │    vendor    │                                                  │        │
│  │    model     │                                                  │        │
│  │    username  │                                                  │        │
│  │    password  │                                                  │        │
│  └──────────────┘                                                  │        │
│         │                                                          │        │
│         │ 1:N                                                      │        │
│         ▼                                                          │        │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐         │        │
│  │    ports     │    │    vlans     │    │ inspections  │         │        │
│  │  (端口信息表)  │    │  (VLAN信息表)  │    │  (巡检结果表)  │         │        │
│  ├──────────────┤    ├──────────────┤    ├──────────────┤         │        │
│  │ PK id        │    │ PK id        │    │ PK id        │         │        │
│  │ FK device_id │    │ FK device_id │    │ FK device_id │         │        │
│  │    port_name │    │    vlan_name │    │    cpu_usage │         │        │
│  │    status    │    │    vlan_desc │    │    memory    │         │        │
│  └──────────────┘    └──────────────┘    └──────────────┘         │        │
│                                                                     │        │
│         │ 1:N                                                      │        │
│         ▼                                                          │        │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐         │        │
│  │configurations│    │ mac_addresses│    │device_versions│        │        │
│  │  (配置信息表)  │    │  (MAC地址表)   │    │ (设备版本信息表)│        │        │
│  ├──────────────┤    ├──────────────┤    ├──────────────┤         │        │
│  │ PK id        │    │ PK id        │    │ PK id        │         │        │
│  │ FK device_id │    │ FK device_id │    │ FK device_id │─────────┘        │
│  │    config    │    │    mac_addr  │    │    sw_version│                  │
│  │    version   │    │    vlan_id   │    │    hw_version│                  │
│  │    git_commit│    │    interface │    │    uptime    │                  │
│  └──────────────┘    └──────────────┘    └──────────────┘                  │
│                                                                            │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐                  │
│  │  git_configs │    │backup_schedules│   │command_history│                 │
│  │ (Git配置表)   │    │ (备份任务表)    │   │ (命令历史表)   │                 │
│  ├──────────────┤    ├──────────────┤    ├──────────────┤                  │
│  │ PK id        │    │ PK id        │    │ PK id        │                  │
│  │    repo_url  │    │ FK device_id │────┘ FK device_id │                  │
│  │    username  │    │    schedule  │    │    command   │                  │
│  │    is_active │    │    is_active │    │    output    │                  │
│  └──────────────┘    └──────────────┘    └──────────────┘                  │
│                                                                            │
│  ┌──────────────┐                                                          │
│  │command_      │                                                          │
│  │ templates    │                                                          │
│  │ (命令模板表)  │                                                          │
│  ├──────────────┤                                                          │
│  │ PK id        │                                                          │
│  │    name      │                                                          │
│  │    command   │                                                          │
│  │    vendor    │                                                          │
│  └──────────────┘                                                          │
│                                                                            │
└────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 核心数据表详解

### 2.1 设备信息表 (devices)

**表说明**: 存储网络设备的基本信息

**表结构**:
```sql
CREATE TABLE devices (
    id INT AUTO_INCREMENT PRIMARY KEY COMMENT '设备ID',
    hostname VARCHAR(255) NOT NULL COMMENT '主机名',
    ip_address VARCHAR(50) NOT NULL UNIQUE COMMENT 'IP地址',
    vendor VARCHAR(50) NOT NULL COMMENT '厂商',
    model VARCHAR(100) NOT NULL COMMENT '型号',
    os_version VARCHAR(100) COMMENT '操作系统版本',
    location VARCHAR(255) COMMENT '位置',
    contact VARCHAR(255) COMMENT '联系人',
    status VARCHAR(20) NOT NULL DEFAULT 'active' COMMENT '状态',
    login_method VARCHAR(20) NOT NULL DEFAULT 'ssh' COMMENT '登录方式',
    login_port INT NOT NULL DEFAULT 22 COMMENT '登录端口',
    username VARCHAR(100) COMMENT '登录用户名',
    password VARCHAR(255) COMMENT '登录密码',
    sn VARCHAR(100) UNIQUE COMMENT '序列号',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    
    INDEX idx_hostname (hostname),
    INDEX idx_ip_address (ip_address),
    INDEX idx_sn (sn)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='设备信息表';
```

**字段说明**:

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | INT | PK, Auto Increment | 主键ID |
| hostname | VARCHAR(255) | NOT NULL, Index | 设备主机名 |
| ip_address | VARCHAR(50) | NOT NULL, Unique, Index | 设备IP地址 |
| vendor | VARCHAR(50) | NOT NULL | 设备厂商(cisco/huawei/h3c/ruijie) |
| model | VARCHAR(100) | NOT NULL | 设备型号 |
| os_version | VARCHAR(100) | Nullable | 操作系统版本 |
| location | VARCHAR(255) | Nullable | 设备位置 |
| contact | VARCHAR(255) | Nullable | 联系人 |
| status | VARCHAR(20) | NOT NULL, Default 'active' | 状态(active/inactive/maintenance/offline) |
| login_method | VARCHAR(20) | NOT NULL, Default 'ssh' | 登录方式(ssh/telnet) |
| login_port | INT | NOT NULL, Default 22 | 登录端口 |
| username | VARCHAR(100) | Nullable | 登录用户名 |
| password | VARCHAR(255) | Nullable | 登录密码(建议加密存储) |
| sn | VARCHAR(100) | Unique, Index | 设备序列号 |
| created_at | DATETIME | NOT NULL, Default CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL, Default CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**关联关系**:
- 1:N ports (一个设备有多个端口)
- 1:N vlans (一个设备有多个VLAN)
- 1:N inspections (一个设备有多条巡检记录)
- 1:N configurations (一个设备有多条配置记录)
- 1:N mac_addresses (一个设备有多个MAC地址)
- 1:N device_versions (一个设备有多个版本信息)
- 1:N backup_schedules (一个设备有多个备份任务)
- 1:N command_history (一个设备有多条命令历史)

---

### 2.2 端口信息表 (ports)

**表说明**: 存储设备的端口信息

**表结构**:
```sql
CREATE TABLE ports (
    id INT AUTO_INCREMENT PRIMARY KEY COMMENT '端口ID',
    device_id INT NOT NULL COMMENT '设备ID',
    port_name VARCHAR(100) NOT NULL COMMENT '端口名称',
    status VARCHAR(20) NOT NULL DEFAULT 'up' COMMENT '端口状态',
    speed VARCHAR(20) COMMENT '端口速率',
    description TEXT COMMENT '端口描述',
    vlan_id INT COMMENT 'VLAN ID',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    
    FOREIGN KEY (device_id) REFERENCES devices(id) ON DELETE CASCADE,
    INDEX idx_device_id (device_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='端口信息表';
```

**字段说明**:

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | INT | PK, Auto Increment | 主键ID |
| device_id | INT | NOT NULL, FK | 设备ID |
| port_name | VARCHAR(100) | NOT NULL | 端口名称(GigabitEthernet1/0/1) |
| status | VARCHAR(20) | NOT NULL, Default 'up' | 端口状态(up/down/disabled) |
| speed | VARCHAR(20) | Nullable | 端口速率(1000 Mbps) |
| description | TEXT | Nullable | 端口描述 |
| vlan_id | INT | Nullable | VLAN ID |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |

---

### 2.3 VLAN信息表 (vlans)

**表说明**: 存储设备的VLAN信息

**表结构**:
```sql
CREATE TABLE vlans (
    id INT AUTO_INCREMENT PRIMARY KEY COMMENT 'VLAN ID',
    device_id INT NOT NULL COMMENT '设备ID',
    vlan_name VARCHAR(100) NOT NULL COMMENT 'VLAN名称',
    vlan_description TEXT COMMENT 'VLAN描述',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    
    FOREIGN KEY (device_id) REFERENCES devices(id) ON DELETE CASCADE,
    INDEX idx_device_id (device_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='VLAN信息表';
```

**字段说明**:

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | INT | PK, Auto Increment | 主键ID |
| device_id | INT | NOT NULL, FK | 设备ID |
| vlan_name | VARCHAR(100) | NOT NULL | VLAN名称(VLAN10) |
| vlan_description | TEXT | Nullable | VLAN描述 |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |

---

### 2.4 巡检结果表 (inspections)

**表说明**: 存储设备巡检结果

**表结构**:
```sql
CREATE TABLE inspections (
    id INT AUTO_INCREMENT PRIMARY KEY COMMENT '巡检ID',
    device_id INT NOT NULL COMMENT '设备ID',
    inspection_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '巡检时间',
    cpu_usage FLOAT COMMENT 'CPU使用率',
    memory_usage FLOAT COMMENT '内存使用率',
    interface_status JSON COMMENT '接口状态',
    error_logs TEXT COMMENT '错误日志',
    status VARCHAR(20) NOT NULL DEFAULT 'completed' COMMENT '巡检状态',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    
    FOREIGN KEY (device_id) REFERENCES devices(id) ON DELETE CASCADE,
    INDEX idx_device_id (device_id),
    INDEX idx_inspection_time (inspection_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='巡检结果表';
```

**字段说明**:

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | INT | PK, Auto Increment | 主键ID |
| device_id | INT | NOT NULL, FK | 设备ID |
| inspection_time | DATETIME | NOT NULL | 巡检时间 |
| cpu_usage | FLOAT | Nullable | CPU使用率(%) |
| memory_usage | FLOAT | Nullable | 内存使用率(%) |
| interface_status | JSON | Nullable | 接口状态JSON |
| error_logs | TEXT | Nullable | 错误日志 |
| status | VARCHAR(20) | NOT NULL, Default 'completed' | 巡检状态 |
| created_at | DATETIME | NOT NULL | 创建时间 |

**interface_status JSON示例**:
```json
{
  "total": 48,
  "up": 45,
  "down": 3,
  "interfaces": [
    {"name": "Gi1/0/1", "status": "up"},
    {"name": "Gi1/0/2", "status": "down"}
  ]
}
```

---

### 2.5 配置信息表 (configurations)

**表说明**: 存储设备配置信息

**表结构**:
```sql
CREATE TABLE configurations (
    id INT AUTO_INCREMENT PRIMARY KEY COMMENT '配置ID',
    device_id INT NOT NULL COMMENT '设备ID',
    config_content TEXT COMMENT '配置内容',
    config_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '配置时间',
    version VARCHAR(50) NOT NULL DEFAULT '1.0' COMMENT '配置版本',
    change_description TEXT COMMENT '变更描述',
    git_commit_id VARCHAR(64) COMMENT 'Git提交ID',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    
    FOREIGN KEY (device_id) REFERENCES devices(id) ON DELETE CASCADE,
    INDEX idx_device_id (device_id),
    INDEX idx_config_time (config_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='配置信息表';
```

**字段说明**:

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | INT | PK, Auto Increment | 主键ID |
| device_id | INT | NOT NULL, FK | 设备ID |
| config_content | TEXT | Nullable | 配置内容(完整配置文本) |
| config_time | DATETIME | NOT NULL | 配置采集时间 |
| version | VARCHAR(50) | NOT NULL, Default '1.0' | 配置版本号 |
| change_description | TEXT | Nullable | 变更描述 |
| git_commit_id | VARCHAR(64) | Nullable | Git提交ID |
| created_at | DATETIME | NOT NULL | 创建时间 |

---

### 2.6 MAC地址表 (mac_addresses)

**表说明**: 存储设备学习到的MAC地址

**表结构**:
```sql
CREATE TABLE mac_addresses (
    id INT AUTO_INCREMENT PRIMARY KEY COMMENT '记录ID',
    device_id INT NOT NULL COMMENT '设备ID',
    mac_address VARCHAR(17) NOT NULL COMMENT 'MAC地址',
    vlan_id INT COMMENT 'VLAN ID',
    interface VARCHAR(100) NOT NULL COMMENT '学习接口',
    address_type VARCHAR(20) NOT NULL DEFAULT 'dynamic' COMMENT '地址类型',
    last_seen DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '最后发现时间',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    
    FOREIGN KEY (device_id) REFERENCES devices(id) ON DELETE CASCADE,
    INDEX idx_device_id (device_id),
    INDEX idx_mac_address (mac_address),
    INDEX idx_last_seen (last_seen)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='MAC地址表';
```

**字段说明**:

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | INT | PK, Auto Increment | 主键ID |
| device_id | INT | NOT NULL, FK | 设备ID |
| mac_address | VARCHAR(17) | NOT NULL, Index | MAC地址(00:11:22:33:44:55) |
| vlan_id | INT | Nullable | VLAN ID |
| interface | VARCHAR(100) | NOT NULL | 学习接口(Gi1/0/1) |
| address_type | VARCHAR(20) | NOT NULL, Default 'dynamic' | 地址类型(static/dynamic) |
| last_seen | DATETIME | NOT NULL | 最后发现时间 |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |

---

### 2.7 设备版本信息表 (device_versions)

**表说明**: 存储设备版本信息

**表结构**:
```sql
CREATE TABLE device_versions (
    id INT AUTO_INCREMENT PRIMARY KEY COMMENT '版本ID',
    device_id INT NOT NULL COMMENT '设备ID',
    software_version VARCHAR(100) COMMENT '软件版本',
    hardware_version VARCHAR(100) COMMENT '硬件版本',
    boot_version VARCHAR(100) COMMENT '启动版本',
    system_image VARCHAR(255) COMMENT '系统镜像',
    uptime VARCHAR(100) COMMENT '运行时间',
    collected_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '采集时间',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    
    FOREIGN KEY (device_id) REFERENCES devices(id) ON DELETE CASCADE,
    INDEX idx_device_id (device_id),
    INDEX idx_collected_at (collected_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='设备版本信息表';
```

**字段说明**:

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | INT | PK, Auto Increment | 主键ID |
| device_id | INT | NOT NULL, FK | 设备ID |
| software_version | VARCHAR(100) | Nullable | 软件版本 |
| hardware_version | VARCHAR(100) | Nullable | 硬件版本 |
| boot_version | VARCHAR(100) | Nullable | 启动版本 |
| system_image | VARCHAR(255) | Nullable | 系统镜像路径 |
| uptime | VARCHAR(100) | Nullable | 运行时间 |
| collected_at | DATETIME | NOT NULL | 采集时间 |
| created_at | DATETIME | NOT NULL | 创建时间 |

---

### 2.8 Git配置表 (git_configs)

**表说明**: 存储Git仓库配置

**表结构**:
```sql
CREATE TABLE git_configs (
    id INT AUTO_INCREMENT PRIMARY KEY COMMENT '配置ID',
    repo_url VARCHAR(255) NOT NULL UNIQUE COMMENT '仓库URL',
    username VARCHAR(100) COMMENT '用户名',
    password VARCHAR(255) COMMENT '密码或Token',
    branch VARCHAR(50) NOT NULL DEFAULT 'main' COMMENT '分支',
    ssh_key_path VARCHAR(255) COMMENT 'SSH密钥路径',
    is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT '是否激活',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='Git配置表';
```

**字段说明**:

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | INT | PK, Auto Increment | 主键ID |
| repo_url | VARCHAR(255) | NOT NULL, Unique | Git仓库URL |
| username | VARCHAR(100) | Nullable | Git用户名 |
| password | VARCHAR(255) | Nullable | 密码或Token |
| branch | VARCHAR(50) | NOT NULL, Default 'main' | Git分支 |
| ssh_key_path | VARCHAR(255) | Nullable | SSH密钥路径 |
| is_active | BOOLEAN | NOT NULL, Default TRUE | 是否激活 |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |

---

### 2.9 备份任务表 (backup_schedules)

**表说明**: 存储设备备份任务计划

**表结构**:
```sql
CREATE TABLE backup_schedules (
    id INT AUTO_INCREMENT PRIMARY KEY COMMENT '任务ID',
    device_id INT NOT NULL COMMENT '设备ID',
    schedule_type VARCHAR(20) NOT NULL DEFAULT 'daily' COMMENT '备份类型',
    time VARCHAR(10) COMMENT '备份时间点(HH:MM)',
    day INT COMMENT '每月备份日期(1-31)',
    is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT '是否激活',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    
    FOREIGN KEY (device_id) REFERENCES devices(id) ON DELETE CASCADE,
    INDEX idx_device_id (device_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='备份任务表';
```

**字段说明**:

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | INT | PK, Auto Increment | 主键ID |
| device_id | INT | NOT NULL, FK | 设备ID |
| schedule_type | VARCHAR(20) | NOT NULL, Default 'daily' | 备份类型(hourly/daily/monthly) |
| time | VARCHAR(10) | Nullable | 备份时间点(HH:MM) |
| day | INT | Nullable | 每月备份日期(1-31) |
| is_active | BOOLEAN | NOT NULL, Default TRUE | 是否激活 |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |

---

### 2.10 命令模板表 (command_templates)

**表说明**: 存储命令模板

**表结构**:
```sql
CREATE TABLE command_templates (
    id INT AUTO_INCREMENT PRIMARY KEY COMMENT '模板ID',
    name VARCHAR(100) NOT NULL UNIQUE COMMENT '模板名称',
    description TEXT COMMENT '模板描述',
    command TEXT NOT NULL COMMENT '命令内容',
    vendor VARCHAR(50) COMMENT '适用厂商',
    device_type VARCHAR(50) COMMENT '适用设备类型',
    variables JSON COMMENT '模板变量定义',
    tags JSON COMMENT '标签列表',
    is_public BOOLEAN NOT NULL DEFAULT TRUE COMMENT '是否公开',
    created_by VARCHAR(100) COMMENT '创建者',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    
    INDEX idx_vendor (vendor),
    INDEX idx_device_type (device_type)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='命令模板表';
```

**字段说明**:

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | INT | PK, Auto Increment | 主键ID |
| name | VARCHAR(100) | NOT NULL, Unique, Index | 模板名称 |
| description | TEXT | Nullable | 模板描述 |
| command | TEXT | NOT NULL | 命令内容 |
| vendor | VARCHAR(50) | Nullable, Index | 适用厂商 |
| device_type | VARCHAR(50) | Nullable, Index | 适用设备类型 |
| variables | JSON | Nullable | 模板变量定义 |
| tags | JSON | Nullable | 标签列表 |
| is_public | BOOLEAN | NOT NULL, Default TRUE | 是否公开 |
| created_by | VARCHAR(100) | Nullable | 创建者 |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |

---

### 2.11 命令历史表 (command_history)

**表说明**: 存储命令执行历史

**表结构**:
```sql
CREATE TABLE command_history (
    id INT AUTO_INCREMENT PRIMARY KEY COMMENT '历史ID',
    device_id INT NOT NULL COMMENT '设备ID',
    command TEXT NOT NULL COMMENT '执行的命令',
    output TEXT COMMENT '命令输出',
    success BOOLEAN NOT NULL COMMENT '执行是否成功',
    error_message TEXT COMMENT '错误信息',
    executed_by VARCHAR(100) COMMENT '执行用户',
    execution_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '执行时间',
    duration FLOAT COMMENT '执行时长(秒)',
    
    FOREIGN KEY (device_id) REFERENCES devices(id) ON DELETE CASCADE,
    INDEX idx_device_id (device_id),
    INDEX idx_execution_time (execution_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='命令历史表';
```

**字段说明**:

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | INT | PK, Auto Increment | 主键ID |
| device_id | INT | NOT NULL, FK | 设备ID |
| command | TEXT | NOT NULL | 执行的命令 |
| output | TEXT | Nullable | 命令输出 |
| success | BOOLEAN | NOT NULL | 执行是否成功 |
| error_message | TEXT | Nullable | 错误信息 |
| executed_by | VARCHAR(100) | Nullable | 执行用户 |
| execution_time | DATETIME | NOT NULL | 执行时间 |
| duration | FLOAT | Nullable | 执行时长(秒) |

---

## 3. SQLAlchemy模型定义

### 3.1 模型基类

```python
# app/models/models.py
from sqlalchemy import Column, Integer, String, Text, Float, DateTime, ForeignKey, JSON, Boolean
from sqlalchemy.orm import declarative_base, relationship
from sqlalchemy.sql import func
from datetime import datetime

Base = declarative_base()
```

### 3.2 核心模型关系

```python
class Device(Base):
    __tablename__ = "devices"
    
    # 字段定义...
    
    # 关联关系
    ports = relationship("Port", back_populates="device", cascade="all, delete-orphan")
    vlans = relationship("VLAN", back_populates="device", cascade="all, delete-orphan")
    inspections = relationship("Inspection", back_populates="device", cascade="all, delete-orphan")
    configurations = relationship("Configuration", back_populates="device", cascade="all, delete-orphan")
    mac_addresses = relationship("MACAddress", back_populates="device", cascade="all, delete-orphan")
    device_versions = relationship("DeviceVersion", back_populates="device", cascade="all, delete-orphan")
    backup_schedules = relationship("BackupSchedule", back_populates="device", cascade="all, delete-orphan")
    command_history = relationship("CommandHistory", back_populates="device", cascade="all, delete-orphan")

class Port(Base):
    __tablename__ = "ports"
    
    # 字段定义...
    device_id = Column(Integer, ForeignKey("devices.id"), nullable=False)
    
    # 关联关系
    device = relationship("Device", back_populates="ports")
```

---

## 4. 数据库统计

### 4.1 表统计

| 表名 | 说明 | 记录数估计 | 主要用途 |
|------|------|-----------|----------|
| devices | 设备信息表 | 100-1000 | 存储网络设备基本信息 |
| ports | 端口信息表 | 1000-10000 | 存储设备端口信息 |
| vlans | VLAN信息表 | 100-1000 | 存储设备VLAN信息 |
| inspections | 巡检结果表 | 10000+ | 存储巡检历史记录 |
| configurations | 配置信息表 | 1000+ | 存储设备配置备份 |
| mac_addresses | MAC地址表 | 10000+ | 存储MAC地址信息 |
| device_versions | 设备版本信息表 | 100-1000 | 存储设备版本信息 |
| git_configs | Git配置表 | 1-10 | 存储Git仓库配置 |
| backup_schedules | 备份任务表 | 100-1000 | 存储备份任务计划 |
| command_templates | 命令模板表 | 10-100 | 存储命令模板 |
| command_history | 命令历史表 | 10000+ | 存储命令执行历史 |

### 4.2 索引统计

| 表名 | 索引数量 | 主要索引 |
|------|----------|----------|
| devices | 3 | id, hostname, ip_address, sn |
| ports | 1 | device_id |
| vlans | 1 | device_id |
| inspections | 2 | device_id, inspection_time |
| configurations | 2 | device_id, config_time |
| mac_addresses | 3 | device_id, mac_address, last_seen |
| device_versions | 2 | device_id, collected_at |
| command_history | 2 | device_id, execution_time |

---

## 5. 数据库优化建议

### 5.1 索引优化
- 为频繁查询的字段添加索引
- 定期分析和优化表
- 使用覆盖索引减少回表查询

### 5.2 数据归档
- 定期归档历史巡检数据
- 清理过期的MAC地址记录
- 限制配置历史保留数量

### 5.3 性能监控
- 监控慢查询日志
- 定期检查表碎片
- 监控连接数和锁等待

---

## 6. 总结

本项目数据库设计遵循以下原则：

1. **规范化设计**：减少数据冗余，保证数据一致性
2. **适当的反规范化**：在性能和一致性之间取得平衡
3. **完善的索引**：提高查询性能
4. **外键约束**：保证数据完整性
5. **级联删除**：删除设备时自动清理关联数据
6. **时间戳字段**：记录数据创建和更新时间

数据库设计支持系统的核心功能，包括设备管理、端口管理、VLAN管理、巡检管理、配置管理、MAC地址管理等功能模块。
